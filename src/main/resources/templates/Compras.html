<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Compras - Sistema ERP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="ComprasStyle.css">

</head>
<body>
    <div class="main-container">
           <!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2><i class="fas fa-chart-line"></i> ERP System</h2>
        <p>Sistema Integral de Gesti√≥n</p>
    </div>
    <ul class="nav-menu">
        <li class="nav-section">
            <div class="nav-section-title">PRINCIPAL</div>
        </li>
        <li class="nav-item" data-modulo="dashboard">
            <a href="/dashboard" class="nav-link active">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="administracion">
            <div class="nav-section-title">ADMINISTRACI√ìN</div>
        </li>
        <li class="nav-item" data-modulo="contabilidad">
            <a href="/Contabilidad" class="nav-link">
                <i class="fas fa-calculator"></i>
                <span>Contabilidad</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="ventas">
            <div class="nav-section-title">VENTAS</div>
        </li>
        <li class="nav-item" data-modulo="Clientes">
            <a href="/Clientes" class="nav-link">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="ventas">
            <a href="/ventas" class="nav-link">
                <i class="fas fa-shopping-cart"></i>
                <span>Ventas</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="punto-venta">
            <a href="/Punto de venta" class="nav-link">
                <i class="fas fa-cash-register"></i>
                <span>Punto de Venta</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="compras">
            <div class="nav-section-title">COMPRAS</div>
        </li>
        <li class="nav-item" data-modulo="Compras">
            <a href="/Compras" class="nav-link">
                <i class="fas fa-shopping-bag"></i>
                <span>Compras</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="inventario">
            <div class="nav-section-title">INVENTARIO</div>
        </li>
        <li class="nav-item" data-modulo="Inventario">
            <a href="/Inventario" class="nav-link">
                <i class="fas fa-boxes"></i>
                <span>Inventario</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="almacenes">
            <a href="/Almacenes" class="nav-link">
                <i class="fas fa-warehouse"></i>
                <span>Almacenes</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="rrhh">
            <div class="nav-section-title">RECURSOS HUMANOS</div>
        </li>
        <li class="nav-item" data-modulo="rrhh">
            <a href="/rrhh" class="nav-link">
                <i class="fas fa-user-tie"></i>
                <span>Empleados</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="logistica">
            <div class="nav-section-title">LOG√çSTICA</div>
        </li>
        <li class="nav-item" data-modulo="logistica">
            <a href="/logistica" class="nav-link">
                <i class="fas fa-shipping-fast"></i>
                <span>Env√≠os</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="analisis">
            <div class="nav-section-title">AN√ÅLISIS</div>
        </li>
        <li class="nav-item" data-modulo="reportes">
            <a href="/reportes" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Reportes</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="sistema">
            <div class="nav-section-title">SISTEMA</div>
        </li>
        <li class="nav-item" data-modulo="configuracion">
            <a href="/configuracion" class="nav-link">
                <i class="fas fa-cog"></i>
                <span>Configuraci√≥n</span>
            </a>
        </li>
        <li>
        <!-- Bot√≥n de cerrar sesi√≥n -->
        <div class="logout-section">
            <button class="btn-logout" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesi√≥n</span>
            </button>
        </div>
        </li>
    </ul>
</aside>

        <!-- ==================== MAIN CONTENT ==================== -->
        <div class="main-content">
            
            <!-- ==================== HEADER ==================== -->
            <header class="page-header">
                <div class="header-left">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div>
                        <h1>
                            <i class="fas fa-shopping-bag"></i> 
                            <span id= "headerTitle">M√≥dulo de Compras</span>
                            </h1>
                        <div class="breadcrumb">
                            <a href="/dashboard"><i class="fas fa-home"></i> Inicio</a>
                            <span>/</span>
                            <span id="breadcrumbModule">Compras</span>
                        </div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" id="btnAccionPrincipal" onclick="abrirModalNuevaCompra()">
                        <i class="fas fa-plus"></i>
                        Nueva Compra
                    </button>
                </div>
            </header>

            <!-- ==================== TABS NAVIGATION ==================== -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" onclick="cambiarTab('compras')" data-tab="compras">
                        <i class="fas fa-shopping-bag"></i>
                        <span>√ìrdenes de Compra</span>
                        <span class="tab-badge" id="badgeCompras">0</span>
                    </button>
                    <button class="tab-button" onclick="cambiarTab('proveedores')" data-tab="proveedores">
                        <i class="fas fa-truck"></i>
                        <span>Proveedores</span>
                        <span class="tab-badge" id="badgeProveedores">0</span>
                    </button>
                </div>
            </div>

            <!-- ==================== TAB 1: COMPRAS ==================== -->
            <div class="tab-content active" id="tab-compras">
                <section class="content-section">
                    
                    <!-- Stats Cards Compras -->
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: var(--azul-principal)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--azul-principal), var(--azul-secundario));">
                                    <i class="fas fa-shopping-bag"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalCompras">0</div>
                            <div class="stat-label">Total de Compras</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--amarillo-advertencia)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--amarillo-advertencia), var(--amarillo-advertencia-dark));">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="comprasPendientes">0</div>
                            <div class="stat-label">Compras Pendientes</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--verde-exito)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--verde-exito), var(--verde-exito-gradient));">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="comprasRecibidas">0</div>
                            <div class="stat-label">Compras Recibidas</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--morado)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--morado), var(--morado-dark));">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="montoTotalMes">$0.00</div>
                            <div class="stat-label">Monto Total del Mes</div>
                        </div>
                    </div>

                    <!-- Toolbar Compras -->
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" class="search-input" id="searchCompras" placeholder="Buscar por n√∫mero de compra, proveedor...">
                        </div>
                        <div class="toolbar-actions">
                            <select class="filter-select" id="estadoFilterCompras">
                                <option value="">Todos los estados</option>
                                <option value="PENDIENTE">Pendiente</option>
                                <option value="RECIBIDA">Recibida</option>
                                <option value="PARCIAL">Parcial</option>
                                <option value="ANULADA">Anulada</option>
                            </select>
                            <button class="btn btn-secondary" onclick="cargarCompras()">
                                <i class="fas fa-sync-alt"></i>
                                Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Compras -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i class="fas fa-list"></i>
                                Listado de Compras
                            </h3>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>N¬∞ Compra</th>
                                    <th>Fecha</th>
                                    <th>Proveedor</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Tipo Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="comprasTableBody">
                                <tr>
                                    <td colspan="7" class="empty-state">
                                        <i class="fas fa-shopping-bag"></i>
                                        <h3>No hay compras registradas</h3>
                                        <p>Comienza creando tu primera orden de compra</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                </section>
            </div>

            <!-- ==================== TAB 2: PROVEEDORES ==================== -->
            <div class="tab-content" id="tab-proveedores">
                <section class="content-section">
                    
                    <!-- Stats Cards Proveedores -->
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: var(--azul-principal)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--azul-principal), var(--azul-secundario));">
                                    <i class="fas fa-truck"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalProveedores">0</div>
                            <div class="stat-label">Total Proveedores</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--verde-exito)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--verde-exito), var(--verde-exito-gradient));">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="proveedoresActivos">0</div>
                            <div class="stat-label">Proveedores Activos</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--rojo-peligro)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--rojo-peligro), var(--rojo-peligro-dark));">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="proveedoresSaldoExcedido">0</div>
                            <div class="stat-label">Saldo Excedido</div>
                        </div>

                        <div class="stat-card" style="border-left-color: var(--morado)">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--morado), var(--morado-dark));">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="totalDeudaProveedores">$0.00</div>
                            <div class="stat-label">Deuda Total</div>
                        </div>
                    </div>

                    <!-- Toolbar Proveedores -->
                    <div class="toolbar">
                        <div class="search-box">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" class="search-input" id="searchProveedores" placeholder="Buscar proveedor por nombre, RFC...">
                        </div>
                        <div class="toolbar-actions">
                            <select class="filter-select" id="estadoFilterProveedores">
                                <option value="">Todos los estados</option>
                                <option value="ACTIVO">Activos</option>
                                <option value="INACTIVO">Inactivos</option>
                            </select>
                            <button class="btn btn-secondary" onclick="cargarProveedores()">
                                <i class="fas fa-sync-alt"></i>
                                Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de Proveedores -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">
                                <i class="fas fa-list"></i>
                                Listado de Proveedores
                            </h3>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>RFC</th>
                                    <th>Contacto</th>
                                    <th>Tel√©fono</th>
                                    <th>L√≠mite Cr√©dito</th>
                                    <th>Saldo Actual</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="proveedoresTableBody">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        <i class="fas fa-truck"></i>
                                        <h3>No hay proveedores registrados</h3>
                                        <p>Agrega tu primer proveedor</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                </section>
            </div>

        </div>
    </div>

    <!-- ==================== MODAL: NUEVA/EDITAR COMPRA ==================== -->
    <div class="modal" id="modalCompra">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalCompraTitle">
                    <i class="fas fa-plus-circle"></i>
                    Nueva Orden de Compra
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalCompra')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCompra">
                    <input type="hidden" id="compraId">
                    
                    <!-- Informaci√≥n General -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-calendar"></i>
                                Fecha de Compra <span class="required">*</span>
                            </label>
                            <input type="date" class="form-input" id="fechaCompra" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-truck"></i>
                                Proveedor <span class="required">*</span>
                            </label>
                            <select class="form-select" id="proveedorId" required>
                                <option value="">Seleccione un proveedor</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-invoice"></i>
                                N¬∞ Factura Proveedor
                            </label>
                            <input type="text" class="form-input" id="numeroFacturaProveedor" placeholder="Ej: FACT-001">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-credit-card"></i>
                                Tipo de Pago <span class="required">*</span>
                            </label>
                            <select class="form-select" id="tipoPago" required>
                                <option value="EFECTIVO">Efectivo</option>
                                <option value="TARJETA">Tarjeta</option>
                                <option value="TRANSFERENCIA">Transferencia</option>
                                <option value="CREDITO">Cr√©dito</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-check"></i>
                                Fecha Entrega Estimada
                            </label>
                            <input type="date" class="form-input" id="fechaEntregaEstimada">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-percentage"></i>
                                Descuento Global
                            </label>
                            <input type="number" class="form-input" id="descuentoGlobal" value="0" min="0" step="0.01">
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-comment"></i>
                                Observaciones
                            </label>
                            <textarea class="form-textarea" id="observaciones" placeholder="Notas adicionales sobre la compra..."></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n de Productos -->
                    <div class="productos-section">
                        <div class="productos-header">
                            <h4 style="color: var(--azul-principal); font-size: 18px;">
                                <i class="fas fa-boxes"></i> Productos
                            </h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarProducto()">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>

                        <table class="productos-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%">Producto</th>
                                    <th style="width: 12%">Cantidad</th>
                                    <th style="width: 15%">Precio Unit.</th>
                                    <th style="width: 12%">Descuento</th>
                                    <th style="width: 15%">Subtotal</th>
                                    <th style="width: 6%"></th>
                                </tr>
                            </thead>
                            <tbody id="productosTableBody">
                                <!-- Los productos se agregar√°n din√°micamente -->
                            </tbody>
                        </table>

                        <!-- Totales -->
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <strong id="subtotalDisplay">$0.00</strong>
                            </div>
                            <div class="total-row">
                                <span>IVA (16%):</span>
                                <strong id="impuestosDisplay">$0.00</strong>
                            </div>
                            <div class="total-row">
                                <span>Descuento:</span>
                                <strong id="descuentoDisplay">$0.00</strong>
                            </div>
                            <div class="total-row final">
                                <span>TOTAL:</span>
                                <strong id="totalDisplay">$0.00</strong>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalCompra')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarCompra()">
                    <i class="fas fa-save"></i>
                    Guardar Compra
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== MODAL: NUEVO/EDITAR PROVEEDOR ==================== -->
    <div class="modal" id="modalProveedor">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modalProveedorTitle">
                    <i class="fas fa-plus-circle"></i>
                    Nuevo Proveedor
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalProveedor')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formProveedor">
                    <input type="hidden" id="proveedorIdEdit">
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-building"></i>
                                Nombre de la Empresa <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="nombreEmpresa" required placeholder="Ej: Distribuidora XYZ S.A.">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i>
                                RFC
                            </label>
                            <input type="text" class="form-input" id="rfcProveedor" placeholder="ABC123456XXX" maxlength="13">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-phone"></i>
                                Tel√©fono
                            </label>
                            <input type="tel" class="form-input" id="telefonoProveedor" placeholder="555-1234567">
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-envelope"></i>
                                Email
                            </label>
                            <input type="email" class="form-input" id="emailProveedor" placeholder="contacto@empresa.com">
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt"></i>
                                Direcci√≥n
                            </label>
                            <textarea class="form-textarea" id="direccionProveedor" placeholder="Calle, n√∫mero, colonia, ciudad..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user"></i>
                                Nombre de Contacto
                            </label>
                            <input type="text" class="form-input" id="contactoNombre" placeholder="Juan P√©rez">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-phone-alt"></i>
                                Tel√©fono de Contacto
                            </label>
                            <input type="tel" class="form-input" id="contactoTelefono" placeholder="555-7654321">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-dollar-sign"></i>
                                L√≠mite de Cr√©dito
                            </label>
                            <input type="number" class="form-input" id="limiteCreditoProveedor" value="0" min="0" step="0.01">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-toggle-on"></i>
                                Estado
                            </label>
                            <select class="form-select" id="estadoProveedor">
                                <option value="ACTIVO">Activo</option>
                                <option value="INACTIVO">Inactivo</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label class="form-label">
                                <i class="fas fa-comment"></i>
                                Observaciones
                            </label>
                            <textarea class="form-textarea" id="observacionesProveedor" placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalProveedor')">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarProveedor()">
                    <i class="fas fa-save"></i>
                    Guardar Proveedor
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== MODAL: VER DETALLES COMPRA ==================== -->
    <div class="modal" id="modalDetallesCompra">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-alt"></i>
                    Detalles de la Compra
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalDetallesCompra')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detallesCompraContent">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalDetallesCompra')">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== MODAL: VER DETALLES PROVEEDOR ==================== -->
    <div class="modal" id="modalDetallesProveedor">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-info-circle"></i>
                    Informaci√≥n del Proveedor
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalDetallesProveedor')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detallesProveedorContent">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalDetallesProveedor')">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    
<script>
// ==================== PARTE 1: VARIABLES, INICIALIZACI√ìN Y CARGA DE DATOS ====================

// ==================== VARIABLES GLOBALES ====================
let compras = [];
let proveedores = [];
let productos = [];
let usuarioActual = null;
let productoIndex = 0;
let tabActual = 'compras';

// ==================== INICIALIZACI√ìN ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üõí M√≥dulo de Compras - Iniciando...');
    
    cargarUsuario();
    cargarProveedores();
    cargarProductos();
    cargarCompras();
    inicializarEventos();
    setFechaHoy();
    
    console.log('‚úÖ M√≥dulo cargado correctamente');
});

// ==================== CARGAR USUARIO ====================
function cargarUsuario() {
    const usuarioStorage = localStorage.getItem('usuario');
    if (usuarioStorage) {
        usuarioActual = JSON.parse(usuarioStorage);
        console.log('üë§ Usuario:', usuarioActual.nombre);
    } else {
        console.warn('‚ö†Ô∏è No hay usuario en sesi√≥n');
    }
}

// ==================== INICIALIZAR EVENTOS ====================
function inicializarEventos() {
    document.getElementById('searchCompras').addEventListener('input', filtrarCompras);
    document.getElementById('estadoFilterCompras').addEventListener('change', filtrarCompras);
    document.getElementById('searchProveedores').addEventListener('input', filtrarProveedores);
    document.getElementById('estadoFilterProveedores').addEventListener('change', filtrarProveedores);
    document.getElementById('descuentoGlobal').addEventListener('input', calcularTotales);
    console.log('üéØ Eventos inicializados');
}

function setFechaHoy() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fechaCompra').value = hoy;
}

// ==================== SISTEMA DE TABS ====================
function cambiarTab(nombreTab) {
    tabActual = nombreTab;
    
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === nombreTab) {
            btn.classList.add('active');
        }
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`tab-${nombreTab}`).classList.add('active');
    
    const btnAccion = document.getElementById('btnAccionPrincipal');
    if (nombreTab === 'compras') {
        btnAccion.innerHTML = '<i class="fas fa-plus"></i> Nueva Compra';
        btnAccion.onclick = abrirModalNuevaCompra;
    } else if (nombreTab === 'proveedores') {
        btnAccion.innerHTML = '<i class="fas fa-plus"></i> Nuevo Proveedor';
        btnAccion.onclick = abrirModalNuevoProveedor;
    }
    
    console.log(`üìë Tab activo: ${nombreTab}`);
}

// ==================== CARGAR DATOS - PROVEEDORES ====================
async function cargarProveedores() {
    try {
        const response = await fetch('/api/proveedores');
        proveedores = await response.json();
        
        const select = document.getElementById('proveedorId');
        select.innerHTML = '<option value="">Seleccione un proveedor</option>';
        
        proveedores.forEach(proveedor => {
            const option = document.createElement('option');
            option.value = proveedor.idProveedor;
            option.textContent = proveedor.nombreEmpresa;
            select.appendChild(option);
        });
        
        renderizarProveedores(proveedores);
        actualizarEstadisticasProveedores();
        
        console.log(`‚úÖ ${proveedores.length} proveedores cargados`);
    } catch (error) {
        console.error('‚ùå Error al cargar proveedores:', error);
        showNotification('Error al cargar proveedores', 'error');
    }
}

// ==================== CARGAR DATOS - PRODUCTOS ====================
async function cargarProductos() {
    try {
        const response = await fetch('/api/productos');
        if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
        }
        productos = await response.json();
        console.log(`‚úÖ ${productos.length} productos cargados`);
        
        // Verificar que los productos tengan los campos necesarios
        if (productos.length > 0) {
            const primerProducto = productos[0];
            console.log('üì¶ Estructura del producto:', {
                idProducto: primerProducto.idProducto,
                nombreProducto: primerProducto.nombreProducto,
                precioCompra: primerProducto.precioCompra
            });
        }
    } catch (error) {
        console.error('‚ùå Error al cargar productos:', error);
        showNotification(`Error al cargar productos: ${error.message}`, 'error');
    }
}

// ==================== CARGAR DATOS - COMPRAS ====================
async function cargarCompras() {
    try {
        const response = await fetch('/api/compras');
        compras = await response.json();
        
        renderizarCompras(compras);
        actualizarEstadisticasCompras();
        
        console.log(`‚úÖ ${compras.length} compras cargadas`);
    } catch (error) {
        console.error('‚ùå Error al cargar compras:', error);
        showNotification('Error al cargar compras', 'error');
    }
}

// ==================== RENDERIZAR TABLA DE COMPRAS ====================
function renderizarCompras(comprasData) {
    const tbody = document.getElementById('comprasTableBody');
    
    if (comprasData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="fas fa-shopping-bag"></i>
                    <h3>No hay compras registradas</h3>
                    <p>Comienza creando tu primera orden de compra</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = comprasData.map(compra => {
        const puedeEditar = compra.estado === 'PENDIENTE';
        const puedeRecibir = compra.estado === 'PENDIENTE' || compra.estado === 'PARCIAL';
        const puedeAnular = compra.estado === 'PENDIENTE' || compra.estado === 'PARCIAL';
        
        return `
        <tr>
            <td><strong>${compra.numeroCompra}</strong></td>
            <td>${formatearFecha(compra.fechaCompra)}</td>
            <td>${compra.proveedor.nombreEmpresa}</td>
            <td><strong style="color: var(--verde-exito)">$${formatearNumero(compra.totalCompra)}</strong></td>
            <td>${getBadgeEstado(compra.estado)}</td>
            <td>${getBadgeTipoPago(compra.tipoPago)}</td>
            <td>
                <button class="btn btn-icon btn-primary" onclick="verDetallesCompra(${compra.idCompra})" title="Ver Detalles">
                    <i class="fas fa-eye"></i>
                </button>
                ${puedeEditar ? `
                <button class="btn btn-icon btn-warning" onclick="editarCompra(${compra.idCompra})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                ` : ''}
                ${puedeRecibir ? `
                <button class="btn btn-icon btn-success" onclick="recibirCompra(${compra.idCompra})" title="Recibir">
                    <i class="fas fa-check"></i>
                </button>
                ` : ''}
                ${puedeAnular ? `
                <button class="btn btn-icon btn-danger" onclick="anularCompra(${compra.idCompra})" title="Anular">
                    <i class="fas fa-ban"></i>
                </button>
                ` : ''}
            </td>
        </tr>
        `;
    }).join('');
}

// ==================== RENDERIZAR TABLA DE PROVEEDORES ====================
function renderizarProveedores(proveedoresData) {
    const tbody = document.getElementById('proveedoresTableBody');
    
    if (proveedoresData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <i class="fas fa-truck"></i>
                    <h3>No hay proveedores registrados</h3>
                    <p>Agrega tu primer proveedor</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = proveedoresData.map(proveedor => `
        <tr>
            <td><strong>${proveedor.nombreEmpresa}</strong></td>
            <td>${proveedor.rfc || 'N/A'}</td>
            <td>${proveedor.contactoNombre || 'N/A'}</td>
            <td>${proveedor.telefono || 'N/A'}</td>
            <td>$${formatearNumero(proveedor.limiteCredito)}</td>
            <td><strong style="color: ${proveedor.saldoActual > proveedor.limiteCredito ? 'var(--rojo-peligro)' : 'var(--verde-exito)'}">$${formatearNumero(proveedor.saldoActual)}</strong></td>
            <td>${getEstadoProveedor(proveedor.estado)}</td>
            <td>
                <button class="btn btn-icon btn-primary" onclick="verDetallesProveedor(${proveedor.idProveedor})" title="Ver Detalles">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-icon btn-warning" onclick="editarProveedor(${proveedor.idProveedor})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                ${proveedor.estado === 'ACTIVO' ? `
                    <button class="btn btn-icon btn-danger" onclick="desactivarProveedor(${proveedor.idProveedor})" title="Desactivar">
                        <i class="fas fa-times"></i>
                    </button>
                ` : `
                    <button class="btn btn-icon btn-success" onclick="activarProveedor(${proveedor.idProveedor})" title="Activar">
                        <i class="fas fa-check"></i>
                    </button>
                `}
            </td>
        </tr>
    `).join('');
}

// ==================== BADGES Y ESTADOS ====================
function getBadgeEstado(estado) {
    const badges = {
        'PENDIENTE': '<span class="badge badge-warning"><i class="fas fa-clock"></i> Pendiente</span>',
        'RECIBIDA': '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Recibida</span>',
        'PARCIAL': '<span class="badge badge-info"><i class="fas fa-hourglass-half"></i> Parcial</span>',
        'ANULADA': '<span class="badge badge-danger"><i class="fas fa-ban"></i> Anulada</span>'
    };
    return badges[estado] || estado;
}

function getBadgeTipoPago(tipo) {
    const badges = {
        'EFECTIVO': '<span class="badge badge-success"><i class="fas fa-money-bill"></i> Efectivo</span>',
        'TARJETA': '<span class="badge badge-info"><i class="fas fa-credit-card"></i> Tarjeta</span>',
        'TRANSFERENCIA': '<span class="badge badge-info"><i class="fas fa-exchange-alt"></i> Transferencia</span>',
        'CREDITO': '<span class="badge badge-warning"><i class="fas fa-clock"></i> Cr√©dito</span>'
    };
    return badges[tipo] || tipo;
}

function getEstadoProveedor(estado) {
    if (estado === 'ACTIVO') {
        return '<span class="estado-visual estado-activo"><span class="estado-dot"></span> Activo</span>';
    } else {
        return '<span class="estado-visual estado-inactivo"><span class="estado-dot"></span> Inactivo</span>';
    }
}

// ==================== ESTAD√çSTICAS - COMPRAS ====================
function actualizarEstadisticasCompras() {
    const total = compras.length;
    const pendientes = compras.filter(c => c.estado === 'PENDIENTE').length;
    const recibidas = compras.filter(c => c.estado === 'RECIBIDA').length;
    
    const mesActual = new Date().getMonth();
    const a√±oActual = new Date().getFullYear();
    const montoMes = compras
        .filter(c => {
            const fecha = new Date(c.fechaCompra);
            return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual;
        })
        .reduce((sum, c) => sum + parseFloat(c.totalCompra), 0);
    
    document.getElementById('totalCompras').textContent = total;
    document.getElementById('comprasPendientes').textContent = pendientes;
    document.getElementById('comprasRecibidas').textContent = recibidas;
    document.getElementById('montoTotalMes').textContent = '$' + formatearNumero(montoMes);
    document.getElementById('badgeCompras').textContent = total;
}

// ==================== ESTAD√çSTICAS - PROVEEDORES ====================
function actualizarEstadisticasProveedores() {
    const total = proveedores.length;
    const activos = proveedores.filter(p => p.estado === 'ACTIVO').length;
    const saldoExcedido = proveedores.filter(p => p.saldoActual > p.limiteCredito).length;
    const deudaTotal = proveedores.reduce((sum, p) => sum + parseFloat(p.saldoActual), 0);
    
    document.getElementById('totalProveedores').textContent = total;
    document.getElementById('proveedoresActivos').textContent = activos;
    document.getElementById('proveedoresSaldoExcedido').textContent = saldoExcedido;
    document.getElementById('totalDeudaProveedores').textContent = '$' + formatearNumero(deudaTotal);
    document.getElementById('badgeProveedores').textContent = total;
}

// ==================== FILTROS - COMPRAS ====================
function filtrarCompras() {
    const searchTerm = document.getElementById('searchCompras').value.toLowerCase();
    const estadoFilter = document.getElementById('estadoFilterCompras').value;
    
    const comprasFiltradas = compras.filter(compra => {
        const matchSearch = !searchTerm || 
            compra.numeroCompra.toLowerCase().includes(searchTerm) ||
            compra.proveedor.nombreEmpresa.toLowerCase().includes(searchTerm);
        
        const matchEstado = !estadoFilter || compra.estado === estadoFilter;
        
        return matchSearch && matchEstado;
    });
    
    renderizarCompras(comprasFiltradas);
}

// ==================== FILTROS - PROVEEDORES ====================
function filtrarProveedores() {
    const searchTerm = document.getElementById('searchProveedores').value.toLowerCase();
    const estadoFilter = document.getElementById('estadoFilterProveedores').value;
    
    const proveedoresFiltrados = proveedores.filter(proveedor => {
        const matchSearch = !searchTerm || 
            proveedor.nombreEmpresa.toLowerCase().includes(searchTerm) ||
            (proveedor.rfc && proveedor.rfc.toLowerCase().includes(searchTerm)) ||
            (proveedor.contactoNombre && proveedor.contactoNombre.toLowerCase().includes(searchTerm));
        
        const matchEstado = !estadoFilter || proveedor.estado === estadoFilter;
        
        return matchSearch && matchEstado;
    });
    
    renderizarProveedores(proveedoresFiltrados);
}
// ==================== PARTE 2: MODALES Y GESTI√ìN DE PRODUCTOS ====================

// ==================== MODAL - NUEVA COMPRA ====================
function abrirModalNuevaCompra() {
    // Verificar que los productos est√©n cargados
    if (productos.length === 0) {
        showNotification('‚ö†Ô∏è Cargando productos...', 'warning');
        cargarProductos().then(() => {
            // Reintentar abrir el modal despu√©s de cargar productos
            abrirModalNuevaCompra();
        }).catch(error => {
            showNotification('‚ùå Error al cargar productos. Intente nuevamente.', 'error');
        });
        return;
    }
    
    document.getElementById('modalCompraTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nueva Orden de Compra';
    document.getElementById('formCompra').reset();
    document.getElementById('compraId').value = '';
    document.getElementById('productosTableBody').innerHTML = '';
    productoIndex = 0;
    calcularTotales();
    setFechaHoy();
    document.getElementById('modalCompra').classList.add('active');
}

// ==================== MODAL - NUEVO PROVEEDOR ====================
function abrirModalNuevoProveedor() {
    document.getElementById('modalProveedorTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Proveedor';
    document.getElementById('formProveedor').reset();
    document.getElementById('proveedorIdEdit').value = '';
    document.getElementById('estadoProveedor').value = 'ACTIVO';
    document.getElementById('modalProveedor').classList.add('active');
}

// ==================== CERRAR MODALES ====================
function cerrarModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ==================== GESTI√ìN DE PRODUCTOS EN COMPRA ====================
function agregarProducto() {
    if (productos.length === 0) {
        showNotification('‚ö†Ô∏è No hay productos disponibles. Cargando productos...', 'warning');
        cargarProductos().then(() => {
            if (productos.length > 0) {
                agregarProducto(); // Reintentar despu√©s de cargar
            } else {
                showNotification('‚ùå No se encontraron productos en el sistema', 'error');
            }
        }).catch(error => {
            showNotification(`‚ùå Error al cargar productos: ${error.message}`, 'error');
        });
        return;
    }
    
    const tbody = document.getElementById('productosTableBody');
    const index = productoIndex++;
    
    const row = document.createElement('tr');
    row.id = `producto-row-${index}`;
    row.innerHTML = `
        <td>
            <select class="form-input producto-select" data-index="${index}" required>
                <option value="">Seleccione producto</option>
                ${productos.map(p => `<option value="${p.idProducto}" data-precio="${p.precioCompra || 0}">${p.nombreProducto || p.nombre || 'Sin nombre'}</option>`).join('')}
            </select>
        </td>
        <td>
            <input type="number" class="form-input producto-cantidad" data-index="${index}" 
                   min="1" step="0.01" value="1" required>
        </td>
        <td>
            <input type="number" class="form-input producto-precio" data-index="${index}" 
                   min="0" step="0.01" value="0" required>
        </td>
        <td>
            <input type="number" class="form-input producto-descuento" data-index="${index}" 
                   min="0" step="0.01" value="0">
        </td>
        <td>
            <strong class="producto-subtotal" data-index="${index}">$0.00</strong>
        </td>
        <td>
            <button type="button" class="btn btn-icon btn-danger" onclick="eliminarProducto(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    
    row.querySelector('.producto-select').addEventListener('change', function(e) {
        const option = e.target.selectedOptions[0];
        if (option && option.value) {
            const precio = parseFloat(option.dataset.precio) || 0;
            row.querySelector('.producto-precio').value = precio;
            calcularSubtotalProducto(index);
        } else {
            // Si no hay producto seleccionado, limpiar el precio
            row.querySelector('.producto-precio').value = 0;
            calcularSubtotalProducto(index);
        }
    });
    
    row.querySelector('.producto-cantidad').addEventListener('input', () => calcularSubtotalProducto(index));
    row.querySelector('.producto-precio').addEventListener('input', () => calcularSubtotalProducto(index));
    row.querySelector('.producto-descuento').addEventListener('input', () => calcularSubtotalProducto(index));
}

function eliminarProducto(index) {
    const row = document.getElementById(`producto-row-${index}`);
    if (row) {
        row.remove();
        calcularTotales();
    }
}

function calcularSubtotalProducto(index) {
    const row = document.getElementById(`producto-row-${index}`);
    if (!row) return;
    
    const cantidad = parseFloat(row.querySelector('.producto-cantidad').value) || 0;
    const precio = parseFloat(row.querySelector('.producto-precio').value) || 0;
    const descuento = parseFloat(row.querySelector('.producto-descuento').value) || 0;
    
    const subtotal = (cantidad * precio) - descuento;
    row.querySelector('.producto-subtotal').textContent = '$' + formatearNumero(subtotal);
    
    calcularTotales();
}

function calcularTotales() {
    let subtotal = 0;
    
    document.querySelectorAll('.producto-subtotal').forEach(element => {
        const valor = element.textContent.replace('$', '').replace(/,/g, '');
        subtotal += parseFloat(valor) || 0;
    });
    
    const descuentoGlobal = parseFloat(document.getElementById('descuentoGlobal').value) || 0;
    const impuestos = subtotal * 0.16;
    const total = subtotal + impuestos - descuentoGlobal;
    
    document.getElementById('subtotalDisplay').textContent = '$' + formatearNumero(subtotal);
    document.getElementById('impuestosDisplay').textContent = '$' + formatearNumero(impuestos);
    document.getElementById('descuentoDisplay').textContent = '$' + formatearNumero(descuentoGlobal);
    document.getElementById('totalDisplay').textContent = '$' + formatearNumero(total);
}

// ==================== GUARDAR COMPRA ====================
async function guardarCompra() {
    if (!document.getElementById('fechaCompra').value) {
        showNotification('Seleccione la fecha de compra', 'error');
        return;
    }
    
    if (!document.getElementById('proveedorId').value) {
        showNotification('Seleccione un proveedor', 'error');
        return;
    }
    
    const productosRows = document.querySelectorAll('#productosTableBody tr');
    if (productosRows.length === 0) {
        showNotification('Agregue al menos un producto', 'error');
        return;
    }
    
    const detalles = [];
    let valid = true;
    
    productosRows.forEach(row => {
        const index = row.id.split('-')[2];
        const productoId = row.querySelector('.producto-select').value;
        const cantidad = row.querySelector('.producto-cantidad').value;
        const precio = row.querySelector('.producto-precio').value;
        const descuento = row.querySelector('.producto-descuento').value || 0;
        
        if (!productoId || !cantidad || !precio) {
            valid = false;
            return;
        }
        
        const subtotal = (parseFloat(cantidad) * parseFloat(precio)) - parseFloat(descuento);
        const impuesto = subtotal * 0.16;
        
        detalles.push({
            producto: { idProducto: parseInt(productoId) },
            cantidad: parseFloat(cantidad),
            precioUnitario: parseFloat(precio),
            descuento: parseFloat(descuento),
            subtotal: subtotal,
            impuesto: impuesto,
            total: subtotal + impuesto
        });
    });
    
    if (!valid) {
        showNotification('Complete todos los campos de los productos', 'error');
        return;
    }
    
    const subtotalTotal = detalles.reduce((sum, d) => sum + d.subtotal, 0);
    const impuestosTotal = detalles.reduce((sum, d) => sum + d.impuesto, 0);
    const descuentoGlobal = parseFloat(document.getElementById('descuentoGlobal').value) || 0;
    
    const compra = {
        fechaCompra: document.getElementById('fechaCompra').value,
        proveedor: { idProveedor: parseInt(document.getElementById('proveedorId').value) },
        usuario: { id: usuarioActual?.id || 1 },
        numeroFacturaProveedor: document.getElementById('numeroFacturaProveedor').value || null,
        tipoPago: document.getElementById('tipoPago').value,
        fechaEntregaEstimada: document.getElementById('fechaEntregaEstimada').value || null,
        observaciones: document.getElementById('observaciones').value || null,
        subtotal: subtotalTotal,
        impuestos: impuestosTotal,
        descuento: descuentoGlobal,
        totalCompra: subtotalTotal + impuestosTotal - descuentoGlobal,
        estado: 'PENDIENTE',
        detalles: detalles
    };
    
    try {
        const response = await fetch('/api/compras', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(compra)
        });
        
        if (!response.ok) {
            throw new Error('Error al guardar la compra');
        }
        
        await response.json();
        showNotification('‚úÖ Compra registrada exitosamente', 'success');
        cerrarModal('modalCompra');
        cargarCompras();
    } catch (error) {
        console.error('Error:', error);
        showNotification('‚ùå Error al guardar la compra', 'error');
    }
}

// ==================== GUARDAR PROVEEDOR ====================
async function guardarProveedor() {
    if (!document.getElementById('nombreEmpresa').value.trim()) {
        showNotification('El nombre de la empresa es requerido', 'error');
        return;
    }
    
    const proveedorId = document.getElementById('proveedorIdEdit').value;
    const proveedor = {
        nombreEmpresa: document.getElementById('nombreEmpresa').value.trim(),
        rfc: document.getElementById('rfcProveedor').value.trim() || null,
        telefono: document.getElementById('telefonoProveedor').value.trim() || null,
        email: document.getElementById('emailProveedor').value.trim() || null,
        direccion: document.getElementById('direccionProveedor').value.trim() || null,
        contactoNombre: document.getElementById('contactoNombre').value.trim() || null,
        contactoTelefono: document.getElementById('contactoTelefono').value.trim() || null,
        limiteCredito: parseFloat(document.getElementById('limiteCreditoProveedor').value) || 0,
        estado: document.getElementById('estadoProveedor').value,
        observaciones: document.getElementById('observacionesProveedor').value.trim() || null
    };
    
    try {
        const url = proveedorId ? `/api/proveedores/${proveedorId}` : '/api/proveedores';
        const method = proveedorId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(proveedor)
        });
        
        if (!response.ok) {
            throw new Error('Error al guardar el proveedor');
        }
        
        await response.json();
        showNotification(`‚úÖ Proveedor ${proveedorId ? 'actualizado' : 'registrado'} exitosamente`, 'success');
        cerrarModal('modalProveedor');
        cargarProveedores();
    } catch (error) {
        console.error('Error:', error);
        showNotification('‚ùå Error al guardar el proveedor', 'error');
    }
}

// ==================== PARTE 3: DETALLES, ACCIONES Y UTILIDADES ====================

// ==================== VER DETALLES COMPRA ====================
async function verDetallesCompra(idCompra) {
    try {
        const response = await fetch(`/api/compras/${idCompra}`);
        const compra = await response.json();
        
        const content = document.getElementById('detallesCompraContent');
        content.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                <div class="form-group">
                    <label class="form-label">N√∫mero de Compra</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px; font-weight: 700;">
                        ${compra.numeroCompra}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px;">
                        ${formatearFecha(compra.fechaCompra)}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Proveedor</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px;">
                        ${compra.proveedor.nombreEmpresa}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Estado</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px;">
                        ${getBadgeEstado(compra.estado)}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Pago</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px;">
                        ${getBadgeTipoPago(compra.tipoPago)}
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">N¬∞ Factura Proveedor</label>
                    <div style="padding: 12px; background: var(--gris-suave-3); border-radius: 8px;">
                        ${compra.numeroFacturaProveedor || 'N/A'}
                    </div>
                </div>
            </div>
            
            <h4 style="color: var(--azul-principal); margin-bottom: 15px;">
                <i class="fas fa-boxes"></i> Productos
            </h4>
            
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Descuento</th>
                        <th>Subtotal</th>
                        <th>IVA</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${compra.detalles.map(detalle => `
                        <tr>
                            <td>${detalle.producto.nombreProducto || detalle.producto.nombre || 'Sin nombre'}</td>
                            <td>${detalle.cantidad}</td>
                            <td>$${formatearNumero(detalle.precioUnitario)}</td>
                            <td>$${formatearNumero(detalle.descuento)}</td>
                            <td>$${formatearNumero(detalle.subtotal)}</td>
                            <td>$${formatearNumero(detalle.impuesto)}</td>
                            <td><strong>$${formatearNumero(detalle.total)}</strong></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="total-section" style="margin-top: 20px;">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <strong>$${formatearNumero(compra.subtotal)}</strong>
                </div>
                <div class="total-row">
                    <span>IVA (16%):</span>
                    <strong>$${formatearNumero(compra.impuestos)}</strong>
                </div>
                <div class="total-row">
                    <span>Descuento:</span>
                    <strong>$${formatearNumero(compra.descuento)}</strong>
                </div>
                <div class="total-row final">
                    <span>TOTAL:</span>
                    <strong>$${formatearNumero(compra.totalCompra)}</strong>
                </div>
            </div>
            
            ${compra.observaciones ? `
                <div style="margin-top: 20px; padding: 15px; background: var(--gris-suave-3); border-radius: 8px;">
                    <strong>Observaciones:</strong>
                    <p style="margin-top: 8px;">${compra.observaciones}</p>
                </div>
            ` : ''}
        `;
        
        document.getElementById('modalDetallesCompra').classList.add('active');
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar los detalles', 'error');
    }
}

// ==================== VER DETALLES PROVEEDOR ====================
async function verDetallesProveedor(idProveedor) {
    try {
        const response = await fetch(`/api/proveedores/${idProveedor}`);
        const proveedor = await response.json();
        
        const content = document.getElementById('detallesProveedorContent');
        content.innerHTML = `
            <div class="info-card">
                <h4 style="color: var(--azul-principal); margin-bottom: 15px;">
                    <i class="fas fa-building"></i> Informaci√≥n Empresarial
                </h4>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-building"></i> Empresa:</span>
                    <span class="info-value">${proveedor.nombreEmpresa}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-id-card"></i> RFC:</span>
                    <span class="info-value">${proveedor.rfc || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-phone"></i> Tel√©fono:</span>
                    <span class="info-value">${proveedor.telefono || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-envelope"></i> Email:</span>
                    <span class="info-value">${proveedor.email || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-map-marker-alt"></i> Direcci√≥n:</span>
                    <span class="info-value">${proveedor.direccion || 'N/A'}</span>
                </div>
            </div>
            
            <div class="info-card">
                <h4 style="color: var(--azul-principal); margin-bottom: 15px;">
                    <i class="fas fa-user"></i> Contacto
                </h4>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-user"></i> Nombre:</span>
                    <span class="info-value">${proveedor.contactoNombre || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-phone-alt"></i> Tel√©fono:</span>
                    <span class="info-value">${proveedor.contactoTelefono || 'N/A'}</span>
                </div>
            </div>
            
            <div class="info-card">
                <h4 style="color: var(--azul-principal); margin-bottom: 15px;">
                    <i class="fas fa-dollar-sign"></i> Informaci√≥n Financiera
                </h4>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-money-bill-wave"></i> L√≠mite de Cr√©dito:</span>
                    <span class="info-value" style="color: var(--azul-principal)">$${formatearNumero(proveedor.limiteCredito)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-wallet"></i> Saldo Actual:</span>
                    <span class="info-value" style="color: ${proveedor.saldoActual > proveedor.limiteCredito ? 'var(--rojo-peligro)' : 'var(--verde-exito)'}">$${formatearNumero(proveedor.saldoActual)}</span>
                </div>
                <div class="info-row">
                    <span class="info-label"><i class="fas fa-toggle-on"></i> Estado:</span>
                    <span class="info-value">${getEstadoProveedor(proveedor.estado)}</span>
                </div>
            </div>
            
            ${proveedor.observaciones ? `
                <div class="info-card">
                    <h4 style="color: var(--azul-principal); margin-bottom: 15px;">
                        <i class="fas fa-comment"></i> Observaciones
                    </h4>
                    <p>${proveedor.observaciones}</p>
                </div>
            ` : ''}
        `;
        
        document.getElementById('modalDetallesProveedor').classList.add('active');
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar los detalles del proveedor', 'error');
    }
}
// ==================== EDITAR COMPRA ====================
async function editarCompra(idCompra) {
    // Buscar la compra en el array para validar su estado
    const compraLocal = compras.find(c => c.idCompra === idCompra);
    
    if (!compraLocal) {
        showNotification('‚ùå Compra no encontrada', 'error');
        return;
    }
    
    // Validar que la compra pueda ser editada
    if (compraLocal.estado !== 'PENDIENTE') {
        showNotification(`‚ö†Ô∏è No se puede editar una compra con estado: ${compraLocal.estado}`, 'warning');
        return;
    }
    
    try {
        const response = await fetch(`/api/compras/${idCompra}`);
        if (!response.ok) {
            throw new Error('Error al cargar la compra');
        }
        
        const compra = await response.json();
        
        // Validar nuevamente el estado desde el servidor
        if (compra.estado !== 'PENDIENTE') {
            showNotification(`‚ö†Ô∏è No se puede editar una compra con estado: ${compra.estado}`, 'warning');
            return;
        }
        
        // Cambiar t√≠tulo del modal
        document.getElementById('modalCompraTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Orden de Compra';
        
        // Llenar campos del formulario
        document.getElementById('compraId').value = compra.idCompra;
        document.getElementById('fechaCompra').value = compra.fechaCompra;
        document.getElementById('proveedorId').value = compra.proveedor.idProveedor;
        document.getElementById('numeroFacturaProveedor').value = compra.numeroFacturaProveedor || '';
        document.getElementById('tipoPago').value = compra.tipoPago;
        document.getElementById('fechaEntregaEstimada').value = compra.fechaEntregaEstimada || '';
        document.getElementById('descuentoGlobal').value = compra.descuento || 0;
        document.getElementById('observaciones').value = compra.observaciones || '';
        
        // Limpiar tabla de productos
        document.getElementById('productosTableBody').innerHTML = '';
        productoIndex = 0;
        
        // Agregar los productos de la compra
        compra.detalles.forEach(detalle => {
            const tbody = document.getElementById('productosTableBody');
            const index = productoIndex++;
            
            const row = document.createElement('tr');
            row.id = `producto-row-${index}`;
            row.innerHTML = `
                <td>
                    <select class="form-input producto-select" data-index="${index}" required>
                        <option value="">Seleccione producto</option>
                        ${productos.map(p => `
                            <option value="${p.idProducto}" 
                                    data-precio="${p.precioCompra || 0}"
                                    ${p.idProducto === detalle.producto.idProducto ? 'selected' : ''}>
                                ${p.nombreProducto || p.nombre || 'Sin nombre'}
                            </option>
                        `).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-input producto-cantidad" data-index="${index}" 
                           min="1" step="0.01" value="${detalle.cantidad}" required>
                </td>
                <td>
                    <input type="number" class="form-input producto-precio" data-index="${index}" 
                           min="0" step="0.01" value="${detalle.precioUnitario}" required>
                </td>
                <td>
                    <input type="number" class="form-input producto-descuento" data-index="${index}" 
                           min="0" step="0.01" value="${detalle.descuento || 0}">
                </td>
                <td>
                    <strong class="producto-subtotal" data-index="${index}">$${formatearNumero(detalle.subtotal)}</strong>
                </td>
                <td>
                    <button type="button" class="btn btn-icon btn-danger" onclick="eliminarProducto(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Agregar eventos a los campos
            row.querySelector('.producto-select').addEventListener('change', function(e) {
                const option = e.target.selectedOptions[0];
                if (option && option.value) {
                    const precio = parseFloat(option.dataset.precio) || 0;
                    row.querySelector('.producto-precio').value = precio;
                    calcularSubtotalProducto(index);
                } else {
                    // Si no hay producto seleccionado, limpiar el precio
                    row.querySelector('.producto-precio').value = 0;
                    calcularSubtotalProducto(index);
                }
            });
            
            row.querySelector('.producto-cantidad').addEventListener('input', () => calcularSubtotalProducto(index));
            row.querySelector('.producto-precio').addEventListener('input', () => calcularSubtotalProducto(index));
            row.querySelector('.producto-descuento').addEventListener('input', () => calcularSubtotalProducto(index));
        });
        
        // Calcular totales
        calcularTotales();
        
        // Abrir modal
        document.getElementById('modalCompra').classList.add('active');
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar la compra', 'error');
    }
}
// ==================== EDITAR PROVEEDOR ====================
async function editarProveedor(idProveedor) {
    try {
        const response = await fetch(`/api/proveedores/${idProveedor}`);
        const proveedor = await response.json();
        
        document.getElementById('modalProveedorTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Proveedor';
        document.getElementById('proveedorIdEdit').value = proveedor.idProveedor;
        document.getElementById('nombreEmpresa').value = proveedor.nombreEmpresa;
        document.getElementById('rfcProveedor').value = proveedor.rfc || '';
        document.getElementById('telefonoProveedor').value = proveedor.telefono || '';
        document.getElementById('emailProveedor').value = proveedor.email || '';
        document.getElementById('direccionProveedor').value = proveedor.direccion || '';
        document.getElementById('contactoNombre').value = proveedor.contactoNombre || '';
        document.getElementById('contactoTelefono').value = proveedor.contactoTelefono || '';
        document.getElementById('limiteCreditoProveedor').value = proveedor.limiteCredito;
        document.getElementById('estadoProveedor').value = proveedor.estado;
        document.getElementById('observacionesProveedor').value = proveedor.observaciones || '';
        
        document.getElementById('modalProveedor').classList.add('active');
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar el proveedor', 'error');
    }
}

// ==================== RECIBIR COMPRA ====================
async function recibirCompra(idCompra) {
    // Buscar la compra en el array para validar su estado
    const compra = compras.find(c => c.idCompra === idCompra);
    
    if (!compra) {
        showNotification('‚ùå Compra no encontrada', 'error');
        return;
    }
    
    // Validar que la compra pueda ser recibida
    if (compra.estado === 'RECIBIDA') {
        showNotification('‚ö†Ô∏è Esta compra ya fue recibida', 'warning');
        return;
    }
    
    if (compra.estado === 'ANULADA') {
        showNotification('‚ö†Ô∏è No se puede recibir una compra anulada', 'warning');
        return;
    }
    
    if (!confirm('¬øConfirma que ha recibido esta compra? Se actualizar√° el inventario.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/compras/${idCompra}/recibir`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            // Intentar leer el mensaje de error del backend
            let errorMessage = 'Error al recibir la compra';
            try {
                const errorData = await response.json();
                if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // Si no se puede parsear el JSON, usar el mensaje por defecto
                errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        showNotification('‚úÖ Compra recibida. Inventario actualizado', 'success');
        cargarCompras();
    } catch (error) {
        console.error('Error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// ==================== ANULAR COMPRA ====================
async function anularCompra(idCompra) {
    // Buscar la compra en el array para validar su estado
    const compra = compras.find(c => c.idCompra === idCompra);
    
    if (!compra) {
        showNotification('‚ùå Compra no encontrada', 'error');
        return;
    }
    
    // Validar que la compra pueda ser anulada
    if (compra.estado === 'RECIBIDA') {
        showNotification('‚ö†Ô∏è No se puede anular una compra ya recibida', 'warning');
        return;
    }
    
    if (compra.estado === 'ANULADA') {
        showNotification('‚ö†Ô∏è Esta compra ya est√° anulada', 'warning');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de anular esta compra? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/compras/${idCompra}/anular`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            // Intentar leer el mensaje de error del backend
            let errorMessage = 'Error al anular la compra';
            try {
                const errorData = await response.json();
                if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // Si no se puede parsear el JSON, usar el mensaje por defecto
                errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        showNotification('‚úÖ Compra anulada exitosamente', 'success');
        cargarCompras();
    } catch (error) {
        console.error('Error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// ==================== DESACTIVAR PROVEEDOR ====================
async function desactivarProveedor(idProveedor) {
    // Buscar el proveedor en el array para validar su estado
    const proveedor = proveedores.find(p => p.idProveedor === idProveedor);
    
    if (!proveedor) {
        showNotification('‚ùå Proveedor no encontrado', 'error');
        return;
    }
    
    // Validar que el proveedor pueda ser desactivado
    if (proveedor.estado === 'INACTIVO') {
        showNotification('‚ö†Ô∏è Este proveedor ya est√° inactivo', 'warning');
        return;
    }
    
    if (!confirm('¬øEst√° seguro de desactivar este proveedor?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/proveedores/${idProveedor}/desactivar`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            // Intentar leer el mensaje de error del backend
            let errorMessage = 'Error al desactivar el proveedor';
            try {
                const errorData = await response.json();
                if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // Si no se puede parsear el JSON, usar el mensaje por defecto
                errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        showNotification('‚úÖ Proveedor desactivado exitosamente', 'success');
        cargarProveedores();
    } catch (error) {
        console.error('Error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// ==================== ACTIVAR PROVEEDOR ====================
async function activarProveedor(idProveedor) {
    // Buscar el proveedor en el array para validar su estado
    const proveedor = proveedores.find(p => p.idProveedor === idProveedor);
    
    if (!proveedor) {
        showNotification('‚ùå Proveedor no encontrado', 'error');
        return;
    }
    
    // Validar que el proveedor pueda ser activado
    if (proveedor.estado === 'ACTIVO') {
        showNotification('‚ö†Ô∏è Este proveedor ya est√° activo', 'warning');
        return;
    }
    
    if (!confirm('¬øEst√° seguro de activar este proveedor?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/proveedores/${idProveedor}/activar`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            // Intentar leer el mensaje de error del backend
            let errorMessage = 'Error al activar el proveedor';
            try {
                const errorData = await response.json();
                if (errorData.message) {
                    errorMessage = errorData.message;
                }
            } catch (e) {
                // Si no se puede parsear el JSON, usar el mensaje por defecto
                errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
        }
        
        showNotification('‚úÖ Proveedor activado exitosamente', 'success');
        cargarProveedores();
    } catch (error) {
        console.error('Error:', error);
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// ==================== SIDEBAR ====================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    
    if (window.innerWidth <= 768) {
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    }
});

// ==================== CERRAR SESI√ìN ====================
function cerrarSesion() {
    if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
        showNotification('Cerrando sesi√≥n...', 'info');
        localStorage.removeItem('usuario');
        
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    }
}

// ==================== UTILIDADES ====================
function formatearFecha(fecha) {
    if (!fecha) return 'N/A';
    const date = new Date(fecha);
    return date.toLocaleDateString('es-MX', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function formatearNumero(numero) {
    return parseFloat(numero).toLocaleString('es-MX', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

// ==================== NOTIFICACIONES ====================
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    let bgColor, icon;
    
    switch(type) {
        case 'success':
            bgColor = 'var(--verde-exito)';
            icon = 'fa-check-circle';
            break;
        case 'error':
            bgColor = 'var(--rojo-peligro)';
            icon = 'fa-exclamation-circle';
            break;
        case 'warning':
            bgColor = 'var(--amarillo-advertencia)';
            icon = 'fa-exclamation-triangle';
            break;
        default:
            bgColor = 'var(--azul-principal)';
            icon = 'fa-info-circle';
    }
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: ${type === 'warning' ? '#333' : 'white'};
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.4s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        max-width: 350px;
    `;
    
    notification.innerHTML = `
        <i class="fas ${icon}" style="font-size: 20px;"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.4s ease';
        setTimeout(() => notification.remove(), 400);
    }, 3500);
}

// ==================== ESTILOS DE ANIMACI√ìN ====================
const styleAnimations = document.createElement('style');
styleAnimations.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
`;
document.head.appendChild(styleAnimations);

// ==================== CONSOLE LOG ====================
console.log('%cüõí M√≥dulo de Compras', 'color: #4a90e2; font-size: 20px; font-weight: bold;');
console.log('%c‚úÖ Sistema cargado', 'color: #28a745; font-size: 14px;');
console.log('%cüìã Funcionalidades:', 'color: #333; font-size: 13px; font-weight: bold;');
console.log('%c  ‚Ä¢ CRUD Compras', 'color: #6c757d; font-size: 12px;');
console.log('%c  ‚Ä¢ CRUD Proveedores', 'color: #6c757d; font-size: 12px;');
console.log('%c  ‚Ä¢ Sistema de tabs', 'color: #6c757d; font-size: 12px;');
console.log('%c  ‚Ä¢ Filtros en tiempo real', 'color: #6c757d; font-size: 12px;');

</script>
</body>
</html>
