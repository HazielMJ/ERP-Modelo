<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ERP - Log√≠stica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="Logis.css">
</head>
<body>
    <div class="container">

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2><i class="fas fa-chart-line"></i> ERP System</h2>
        <p>Sistema Integral de Gesti√≥n</p>
    </div>
    <ul class="nav-menu">
        <li class="nav-section">
            <div class="nav-section-title">PRINCIPAL</div>
        </li>
        <li class="nav-item" data-modulo="dashboard">
            <a href="/dashboard" class="nav-link active">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="administracion">
            <div class="nav-section-title">ADMINISTRACI√ìN</div>
        </li>
        <li class="nav-item" data-modulo="contabilidad">
            <a href="/Contabilidad" class="nav-link">
                <i class="fas fa-calculator"></i>
                <span>Contabilidad</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="ventas">
            <div class="nav-section-title">VENTAS</div>
        </li>
        <li class="nav-item" data-modulo="Clientes">
            <a href="/Clientes" class="nav-link">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="ventas">
            <a href="/ventas" class="nav-link">
                <i class="fas fa-shopping-cart"></i>
                <span>Ventas</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="punto-venta">
            <a href="/Punto de venta" class="nav-link">
                <i class="fas fa-cash-register"></i>
                <span>Punto de Venta</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="compras">
            <div class="nav-section-title">COMPRAS</div>
        </li>
        <li class="nav-item" data-modulo="Compras">
            <a href="/Compras" class="nav-link">
                <i class="fas fa-shopping-bag"></i>
                <span>Compras</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="inventario">
            <div class="nav-section-title">INVENTARIO</div>
        </li>
        <li class="nav-item" data-modulo="Inventario">
            <a href="/Inventario" class="nav-link">
                <i class="fas fa-boxes"></i>
                <span>Inventario</span>
            </a>
        </li>
        <li class="nav-item" data-modulo="almacenes">
            <a href="/Almacenes" class="nav-link">
                <i class="fas fa-warehouse"></i>
                <span>Almacenes</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="rrhh">
            <div class="nav-section-title">RECURSOS HUMANOS</div>
        </li>
        <li class="nav-item" data-modulo="rrhh">
            <a href="/rrhh" class="nav-link">
                <i class="fas fa-user-tie"></i>
                <span>Empleados</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="logistica">
            <div class="nav-section-title">LOG√çSTICA</div>
        </li>
        <li class="nav-item" data-modulo="logistica">
            <a href="/logistica" class="nav-link">
                <i class="fas fa-shipping-fast"></i>
                <span>Env√≠os</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="analisis">
            <div class="nav-section-title">AN√ÅLISIS</div>
        </li>
        <li class="nav-item" data-modulo="reportes">
            <a href="/reportes" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Reportes</span>
            </a>
        </li>
        
        <li class="nav-section" data-seccion="sistema">
            <div class="nav-section-title">SISTEMA</div>
        </li>
        <li class="nav-item" data-modulo="configuracion">
            <a href="/configuracion" class="nav-link">
                <i class="fas fa-cog"></i>
                <span>Configuraci√≥n</span>
            </a>
        </li>
        <li>
        <div class="logout-section">
            <button class="btn-logout" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesi√≥n</span>
            </button>
        </div>
        </li>
    </ul>
</aside>

     
        <main class="main-content">
 
       <header class="header">
    <div class="header-content">
        <div class="header-left">
            <h1><i class="fas fa-shipping-fast"></i> Log√≠stica</h1>
        </div>
        <div class="breadcrumb">
            <a href="/dashboard"><i class="fas fa-home"></i> Inicio</a>
            <span>/</span>
            <span>Log√≠stica y Env√≠os</span>
        </div>
    </div>
</header>

            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" onclick="switchTab('envios')" data-tab="envios">
                        <i class="fas fa-box"></i>
                        <span>Env√≠os</span>
                        <span class="tab-badge" id="badgeEnvios">0</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('metodos')" data-tab="metodos">
                        <i class="fas fa-shipping-fast"></i>
                        <span>M√©todos de Env√≠o</span>
                        <span class="tab-badge" id="badgeMetodos">0</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('transportistas')" data-tab="transportistas">
                        <i class="fas fa-user-tie"></i>
                        <span>Transportistas</span>
                        <span class="tab-badge" id="badgeTransportistas">0</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('rutas')" data-tab="rutas">
                        <i class="fas fa-route"></i>
                        <span>Rutas</span>
                        <span class="tab-badge" id="badgeRutas">0</span>
                    </button>
                </div>
            </div>

 
            <div class="content-area">

                <div class="stats-grid">
                    <div class="stat-card" style="--stat-color: linear-gradient(45deg, #FF6F00, #E65100);">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalEnvios">0</h3>
                            <p>Env√≠os Totales</p>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: linear-gradient(45deg, #6f42c1, #5936a8);">
                        <div class="stat-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="enviosEnTransito">0</h3>
                            <p>En Tr√°nsito</p>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: linear-gradient(45deg, var(--verde-exito), var(--verde-exito-gradient));">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="enviosEntregados">0</h3>
                            <p>Entregados</p>
                        </div>
                    </div>
                    <div class="stat-card" style="--stat-color: linear-gradient(45deg, var(--amarillo-advertencia), #e0a800);">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="enviosPendientes">0</h3>
                            <p>Pendientes</p>
                        </div>
                    </div>
                </div>

                <div id="tab-envios" class="tab-content active">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchEnvios" placeholder="Buscar por n√∫mero de gu√≠a, cliente...">
                            <button class="btn btn-secondary" onclick="buscarEnvios()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <button class="btn btn-primary" onclick="mostrarModalEnvio()">
                            <i class="fas fa-plus"></i> Nuevo Env√≠o
                        </button>
                    </div>

                    <div class="filter-bar">
                        <select class="filter-select" id="filterEstadoEnvio" onchange="filtrarEnvios()">
                            <option value="">Todos los estados</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="PREPARANDO">Preparando</option>
                            <option value="EN_TRANSITO">En Tr√°nsito</option>
                            <option value="ENTREGADO">Entregado</option>
                            <option value="CANCELADO">Cancelado</option>
                            <option value="DEVUELTO">Devuelto</option>
                        </select>
                    </div>

                    <div class="card">
                        <div class="loading" id="loadingEnvios">
                            <div class="spinner"></div>
                            <p>Cargando env√≠os...</p>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>N¬∞ Gu√≠a</th>
                                        <th>Cliente</th>
                                        <th>Destino</th>
                                        <th>M√©todo</th>
                                        <th>Transportista</th>
                                        <th>Estado</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Costo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="enviosBody">
                                    <tr>
                                        <td colspan="9">
                                            <div class="empty-state">
                                                <i class="fas fa-box-open"></i>
                                                <h3>No hay env√≠os registrados</h3>
                                                <p>Comienza creando un nuevo env√≠o</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-metodos" class="tab-content">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchMetodos" placeholder="Buscar m√©todos de env√≠o...">
                        </div>
                        <button class="btn btn-primary" onclick="mostrarModalMetodo()">
                            <i class="fas fa-plus"></i> Nuevo M√©todo
                        </button>
                    </div>

                    <div class="card">
                        <div class="loading" id="loadingMetodos">
                            <div class="spinner"></div>
                            <p>Cargando m√©todos de env√≠o...</p>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Descripci√≥n</th>
                                        <th>Costo Base</th>
                                        <th>Costo por Km</th>
                                        <th>Tiempo Estimado</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="metodosBody">
                                    <tr>
                                        <td colspan="7">
                                            <div class="empty-state">
                                                <i class="fas fa-shipping-fast"></i>
                                                <h3>No hay m√©todos de env√≠o registrados</h3>
                                                <p>Comienza agregando un nuevo m√©todo</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-transportistas" class="tab-content">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchTransportistas" placeholder="Buscar transportistas...">
                        </div>
                        <button class="btn btn-primary" onclick="mostrarModalTransportista()">
                            <i class="fas fa-plus"></i> Nuevo Transportista
                        </button>
                    </div>

                    <div class="card">
                        <div class="loading" id="loadingTransportistas">
                            <div class="spinner"></div>
                            <p>Cargando transportistas...</p>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Empresa</th>
                                        <th>Tel√©fono</th>
                                        <th>Email</th>
                                        <th>Tipo Veh√≠culo</th>
                                        <th>Placa</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="transportistasBody">
                                    <tr>
                                        <td colspan="8">
                                            <div class="empty-state">
                                                <i class="fas fa-user-tie"></i>
                                                <h3>No hay transportistas registrados</h3>
                                                <p>Comienza agregando un nuevo transportista</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-rutas" class="tab-content">
                    <div class="action-bar">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchRutas" placeholder="Buscar rutas...">
                        </div>
                        <button class="btn btn-primary" onclick="mostrarModalRuta()">
                            <i class="fas fa-plus"></i> Nueva Ruta
                        </button>
                    </div>

                    <div class="card">
                        <div class="loading" id="loadingRutas">
                            <div class="spinner"></div>
                            <p>Cargando rutas...</p>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                        <th>Origen</th>
                                        <th>Destino</th>
                                        <th>Distancia (Km)</th>
                                        <th>Tiempo (Min)</th>
                                        <th>Costo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="rutasBody">
                                    <tr>
                                        <td colspan="9">
                                            <div class="empty-state">
                                                <i class="fas fa-route"></i>
                                                <h3>No hay rutas registradas</h3>
                                                <p>Comienza agregando una nueva ruta</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div class="modal" id="modalEnvio">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-box"></i> <span id="tituloModalEnvio">Nuevo Env√≠o</span></h2>
                <button class="close-btn" onclick="cerrarModalEnvio()">&times;</button>
            </div>
            <div class="modal-body">
            <form id="formEnvio" onsubmit="guardarEnvio(event)">
                <input type="hidden" id="envioId">
                
                <h3 class="form-section-title"><i class="fas fa-user"></i> Informaci√≥n del Cliente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="envioClienteId" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Venta (Opcional)</label>
                        <select id="envioVentaId">
                            <option value="">Sin venta asociada</option>
                        </select>
                    </div>
                </div>

                <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> Direcci√≥n de Entrega</h3>
                <div class="form-group">
                    <label>Direcci√≥n Completa *</label>
                    <textarea id="envioDireccion" rows="2" required placeholder="Calle, n√∫mero, colonia..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad *</label>
                        <input type="text" id="envioCiudad" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <input type="text" id="envioEstado" required>
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" id="envioCP" maxlength="10">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono de Contacto</label>
                        <input type="tel" id="envioTelefono">
                    </div>
                    <div class="form-group">
                        <label>Referencias</label>
                        <input type="text" id="envioReferencias" placeholder="Ej: Casa azul, cerca del parque">
                    </div>
                </div>

                <h3 class="form-section-title"><i class="fas fa-shipping-fast"></i> Detalles del Env√≠o</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>M√©todo de Env√≠o</label>
                        <select id="envioMetodoId">
                            <option value="">Seleccionar m√©todo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ruta</label>
                        <select id="envioRutaId">
                            <option value="">Seleccionar ruta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Transportista</label>
                        <select id="envioTransportistaId">
                            <option value="">Seleccionar transportista</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Estimada de Entrega</label>
                        <input type="date" id="envioFechaEstimada">
                    </div>
                    <div class="form-group">
                        <label>Peso (Kg)</label>
                        <input type="number" id="envioPeso" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Costo de Env√≠o</label>
                        <input type="number" id="envioCosto" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="envioObservaciones" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>

            </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalEnvio()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="formEnvio" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
        </div>
    </div>
    <div class="modal" id="modalMetodo">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-shipping-fast"></i> <span id="tituloModalMetodo">Nuevo M√©todo de Env√≠o</span></h2>
                <button class="close-btn" onclick="cerrarModalMetodo()">&times;</button>
            </div>
            <div class="modal-body">
            <form id="formMetodo" onsubmit="guardarMetodo(event)">
                <input type="hidden" id="metodoId">
                
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="metodoNombre" required placeholder="Ej: Env√≠o Express">
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="metodoDescripcion" rows="2" placeholder="Descripci√≥n del m√©todo..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Costo Base</label>
                        <input type="number" id="metodoCostoBase" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Costo por Km</label>
                        <input type="number" id="metodoCostoPorKm" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tiempo Estimado</label>
                    <input type="text" id="metodoTiempo" placeholder="Ej: 24-48 horas">
                </div>

            </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalMetodo()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="formMetodo" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
        </div>
    </div>
    <div class="modal" id="modalTransportista">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-tie"></i> <span id="tituloModalTransportista">Nuevo Transportista</span></h2>
                <button class="close-btn" onclick="cerrarModalTransportista()">&times;</button>
            </div>
            <div class="modal-body">
            <form id="formTransportista" onsubmit="guardarTransportista(event)">
                <input type="hidden" id="transportistaId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="transportistaNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Empresa</label>
                        <input type="text" id="transportistaEmpresa">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="transportistaTelefono">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="transportistaEmail">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Veh√≠culo</label>
                        <input type="text" id="transportistaTipoVehiculo" placeholder="Ej: Camioneta 3.5 ton">
                    </div>
                    <div class="form-group">
                        <label>Placa del Veh√≠culo</label>
                        <input type="text" id="transportistaPlaca">
                    </div>
                </div>
                <div class="form-group">
                    <label>Licencia</label>
                    <input type="text" id="transportistaLicencia">
                </div>

            </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalTransportista()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="formTransportista" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
        </div>
    </div>

    <div class="modal" id="modalRuta">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-route"></i> <span id="tituloModalRuta">Nueva Ruta</span></h2>
                <button class="close-btn" onclick="cerrarModalRuta()">&times;</button>
            </div>
            <div class="modal-body">
            <form id="formRuta" onsubmit="guardarRuta(event)">
                <input type="hidden" id="rutaId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo de Ruta</label>
                        <input type="text" id="rutaCodigo" placeholder="Ej: R-001">
                    </div>
                    <div class="form-group">
                        <label>Nombre de Ruta</label>
                        <input type="text" id="rutaNombre" placeholder="Ej: Ruta Centro">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Origen</label>
                        <input type="text" id="rutaOrigen" placeholder="Ciudad/Zona de origen">
                    </div>
                    <div class="form-group">
                        <label>Destino</label>
                        <input type="text" id="rutaDestino" placeholder="Ciudad/Zona de destino">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Distancia (Km)</label>
                        <input type="number" id="rutaDistancia" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Tiempo Estimado (Min)</label>
                        <input type="number" id="rutaTiempo" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Costo Estimado</label>
                        <input type="number" id="rutaCosto" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Referencias</label>
                    <textarea id="rutaReferencias" rows="3" placeholder="Puntos de referencia, indicaciones..."></textarea>
                </div>

            </form>
            </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalRuta()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" form="formRuta" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
        </div>
    </div>

    <div class="modal" id="modalSeguimiento">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-map-marked-alt"></i> Seguimiento del Env√≠o</h2>
                <button class="close-btn" onclick="cerrarModalSeguimiento()">&times;</button>
            </div>
            <div id="contenidoSeguimiento">
                <div class="loading active">
                    <div class="spinner"></div>
                    <p>Cargando seguimiento...</p>
                </div>
            </div>
        </div>
    </div>
    <script>
const API_BASE = 'http://localhost:8082/api';

async function verificarConexion() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(`${API_BASE}/envios`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        return response.ok;
    } catch (error) {
        console.error('‚ùå Servidor no disponible:', error);
        showNotification('‚ö†Ô∏è No se puede conectar al servidor', 'error');
        return false;
    }
}


document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Iniciando aplicaci√≥n...');
    
    inicializarSidebar();
    inicializarEventListeners();
    
    const conectado = await verificarConexion();
    
    if (conectado) {
        console.log('‚úÖ Servidor conectado');
        
        Promise.all([
            cargarEnvios(),
            cargarMetodos(),
            cargarTransportistas(),
            cargarRutas(),
            actualizarEstadisticas()
        ]).then(() => {
            console.log('‚úÖ Todos los datos cargados correctamente');
            showNotification('¬°Bienvenido al m√≥dulo de Log√≠stica!', 'success');
        }).catch(error => {
            console.error('‚ùå Error al cargar datos iniciales:', error);
            showNotification('Algunos datos no pudieron cargarse. Por favor, recarga la p√°gina.', 'warning');
        });
    } else {
        mostrarErrorConexion();
    }
});

function mostrarErrorConexion() {
    const tbody = document.getElementById('enviosBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <h3>No se puede conectar al servidor</h3>
                        <p>Verifica que el servidor est√© corriendo en <code>http://localhost:8082</code></p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Reintentar
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    document.querySelectorAll('.loading').forEach(el => el.classList.remove('active'));
}
function validarTransicionEstado(estadoActual, estadoNuevo) {
    const transicionesInvalidas = {
        'ENTREGADO': ['PENDIENTE', 'PREPARANDO', 'EN_TRANSITO'],
        'CANCELADO': ['EN_TRANSITO', 'ENTREGADO', 'DEVUELTO']
    };
    
    if (transicionesInvalidas[estadoActual]?.includes(estadoNuevo)) {
        return `No puedes cambiar de ${getEstadoTexto(estadoActual)} a ${getEstadoTexto(estadoNuevo)}`;
    }
    
    if (estadoActual === 'DEVUELTO' && estadoNuevo !== 'DEVUELTO') {
        return 'Un env√≠o devuelto no puede cambiar a otro estado';
    }
    
    return null;
}

function aplicarEstiloEstado(selectElement, estado) {
    const estilos = {
        'PENDIENTE': { bg: '#fff3cd', border: '#ffc107', color: '#856404' },
        'PREPARANDO': { bg: '#d1ecf1', border: '#17a2b8', color: '#0c5460' },
        'EN_TRANSITO': { bg: '#e2d9f3', border: '#6f42c1', color: '#4e2a84' },
        'ENTREGADO': { bg: '#d4edda', border: '#28a745', color: '#155724' },
        'CANCELADO': { bg: '#f8d7da', border: '#dc3545', color: '#721c24' },
        'DEVUELTO': { bg: '#f8d7da', border: '#dc3545', color: '#721c24' }
    };
    
    const estilo = estilos[estado] || { bg: '#fff', border: '#ccc', color: '#333' };
    
    selectElement.style.backgroundColor = estilo.bg;
    selectElement.style.borderColor = estilo.border;
    selectElement.style.color = estilo.color;
    selectElement.style.fontWeight = '600';
    selectElement.style.transition = 'all 0.3s ease';
}

function getBackgroundEstado(estado) {
    const colores = {
        'PENDIENTE': '#fff3cd',
        'PREPARANDO': '#d1ecf1',
        'EN_TRANSITO': '#e2d9f3',
        'ENTREGADO': '#d4edda',
        'CANCELADO': '#f8d7da',
        'DEVUELTO': '#f8d7da'
    };
    return colores[estado] || '#fff';
}

function getBorderEstado(estado) {
    const colores = {
        'PENDIENTE': '#ffc107',
        'PREPARANDO': '#17a2b8',
        'EN_TRANSITO': '#6f42c1',
        'ENTREGADO': '#28a745',
        'CANCELADO': '#dc3545',
        'DEVUELTO': '#dc3545'
    };
    return colores[estado] || '#ccc';
}

function getColorEstado(estado) {
    const colores = {
        'PENDIENTE': '#856404',
        'PREPARANDO': '#0c5460',
        'EN_TRANSITO': '#4e2a84',
        'ENTREGADO': '#155724',
        'CANCELADO': '#721c24',
        'DEVUELTO': '#721c24'
    };
    return colores[estado] || '#333';
}

async function cargarEnvios() {
    const loading = document.getElementById('loadingEnvios');
    const tbody = document.getElementById('enviosBody');
    
    if (!tbody) return;
    
    loading?.classList.add('active');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${API_BASE}/envios`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const envios = await response.json();
        console.log(`üì¶ ${envios.length} env√≠os cargados`);
        
        if (envios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No hay env√≠os registrados</h3>
                            <p>Comienza creando un nuevo env√≠o</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = envios.map(envio => {
                const estado = envio.estado || 'PENDIENTE';
                return `
                <tr>
                    <td><strong>${envio.numeroGuia || 'Sin gu√≠a'}</strong></td>
                    <td>${envio.cliente?.nombreRazonSocial || 'N/A'}</td>
                    <td>${envio.ciudad || 'N/A'}, ${envio.estadoDestino || ''}</td>
                    <td>${envio.metodoEnvio?.nombre || 'N/A'}</td>
                    <td>${envio.transportista?.nombre || 'Sin asignar'}</td>
                    <td>
                        <select class="estado-select" 
                                onchange="cambiarEstadoRapido(${envio.idEnvio}, this.value, this)" 
                                data-estado-actual="${estado}"
                                data-envio-id="${envio.idEnvio}"
                                style="background-color: ${getBackgroundEstado(estado)}; 
                                       border-color: ${getBorderEstado(estado)}; 
                                       color: ${getColorEstado(estado)}; 
                                       font-weight: 600;">
                            <option value="PENDIENTE" ${estado === 'PENDIENTE' ? 'selected' : ''}>‚è≥ Pendiente</option>
                            <option value="PREPARANDO" ${estado === 'PREPARANDO' ? 'selected' : ''}>üì¶ Preparando</option>
                            <option value="EN_TRANSITO" ${estado === 'EN_TRANSITO' ? 'selected' : ''}>üöö En Tr√°nsito</option>
                            <option value="ENTREGADO" ${estado === 'ENTREGADO' ? 'selected' : ''}>‚úÖ Entregado</option>
                            <option value="CANCELADO" ${estado === 'CANCELADO' ? 'selected' : ''}>‚ùå Cancelado</option>
                            <option value="DEVUELTO" ${estado === 'DEVUELTO' ? 'selected' : ''}>‚Ü©Ô∏è Devuelto</option>
                        </select>
                    </td>
                    <td>${formatearFecha(envio.fechaCreacion)}</td>
                    <td>${formatearMoneda(envio.costoEnvio)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="verSeguimiento(${envio.idEnvio})" title="Ver seguimiento">
                                <i class="fas fa-map-marked-alt"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editarEnvio(${envio.idEnvio})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEnvio(${envio.idEnvio})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            actualizarEstadisticas();
        }
        
    } catch (error) {
        console.error('‚ùå Error al cargar env√≠os:', error);
        
        if (error.name === 'AbortError') {
            showNotification('‚è±Ô∏è Tiempo de espera agotado', 'error');
        } else {
            showNotification('Error al cargar env√≠os', 'error');
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="cargarEnvios()">
                            <i class="fas fa-sync"></i> Reintentar
                        </button>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading?.classList.remove('active');
    }
}
function inicializarSidebar() {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleBtn');

    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            const icon = this.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-angle-left');
                icon.classList.add('fa-angle-right');
            } else {
                icon.classList.remove('fa-angle-right');
                icon.classList.add('fa-angle-left');
            }
        });
    }
}
function inicializarEventListeners() {
    const searchEnvios = document.getElementById('searchEnvios');
    if (searchEnvios) searchEnvios.addEventListener('input', buscarEnvios);
    
    const searchMetodos = document.getElementById('searchMetodos');
    if (searchMetodos) searchMetodos.addEventListener('input', buscarMetodos);
    
    const searchTransportistas = document.getElementById('searchTransportistas');
    if (searchTransportistas) searchTransportistas.addEventListener('input', buscarTransportistas);
    
    const searchRutas = document.getElementById('searchRutas');
    if (searchRutas) searchRutas.addEventListener('input', buscarRutas);
    
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const activeButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
    
    document.getElementById(`tab-${tabName}`).classList.add('active');

    if (tabName === 'envios') cargarEnvios();
    if (tabName === 'metodos') cargarMetodos();
    if (tabName === 'transportistas') cargarTransportistas();
    if (tabName === 'rutas') cargarRutas();
}
function cerrarSesion() {
    if (confirm('Estas seguro que deseas cerrar sesi√≥n')) {
        showNotification('Cerrando sesi√≥n...', 'info');
        setTimeout(() => {
            window.location.href = '/login';
        }, 1000);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--azul-principal);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    if (type === 'success') notification.style.background = '#28a745';
    if (type === 'error') notification.style.background = '#dc3545';
    if (type === 'warning') notification.style.background = '#ffc107';
    
    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
    notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

function formatearFecha(fecha) {
    if (!fecha) return 'N/A';
    const date = new Date(fecha);
    return date.toLocaleDateString('es-MX', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatearMoneda(valor) {
    if (!valor) return '$0.00';
    return '$' + parseFloat(valor).toLocaleString('es-MX', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

async function actualizarEstadisticas() {
    try {
        const response = await fetch(`${API_BASE}/envios`);
        
        if (!response.ok) {
            console.warn('No se pudieron cargar las estad√°sticas');
            return;
        }
        
        const envios = await response.json();
        
        document.getElementById('totalEnvios').textContent = envios.length || 0;
        
        const enTransito = envios.filter(e => e.estado === 'EN_TRANSITO').length;
        document.getElementById('enviosEnTransito').textContent = enTransito;
        
        const pendientes = envios.filter(e => e.estado === 'PENDIENTE' || e.estado === 'PREPARANDO').length;
        document.getElementById('enviosPendientes').textContent = pendientes;
        
        const entregados = envios.filter(e => e.estado === 'ENTREGADO').length;
        document.getElementById('enviosEntregados').textContent = entregados;
        
        const badgeEnvios = document.getElementById('badgeEnvios');
        if (badgeEnvios) badgeEnvios.textContent = envios.length || 0;
        
    } catch (error) {
        console.error('Error al actualizar estad√≠sticas:', error);
    }
}

async function cargarEnvios() {
    const loading = document.getElementById('loadingEnvios');
    const tbody = document.getElementById('enviosBody');
    
    loading.classList.add('active');
    
    try {
        const response = await fetch(`${API_BASE}/envios`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const envios = await response.json();
        
        console.log('Env√≠os cargados:', envios);
        
        if (envios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No hay env√≠os registrados</h3>
                            <p>Comienza creando un nuevo env√≠o</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = envios.map(envio => `
                <tr>
                    <td><strong>${envio.numeroGuia || 'Sin gu√≠a'}</strong></td>
                    <td>${envio.cliente?.nombreRazonSocial || 'N/A'}</td>
                    <td>${envio.ciudad || 'N/A'}, ${envio.estadoDestino || ''}</td>
                    <td>${envio.metodoEnvio?.nombre || 'N/A'}</td>
                    <td>${envio.transportista?.nombre || 'Sin asignar'}</td>
                  <td>
     <select class="estado-select" onchange="cambiarEstadoRapido(${envio.idEnvio}, this.value, this)" data-estado-actual="${envio.estado || 'PENDIENTE'}" data-envio-id="${envio.idEnvio}">
        <option value="PENDIENTE" ${(envio.estado === 'PENDIENTE' || !envio.estado) ? 'selected' : ''}>‚è≥ Pendiente</option>
        <option value="PREPARANDO" ${envio.estado === 'PREPARANDO' ? 'selected' : ''}>üì¶ Preparando</option>
        <option value="EN_TRANSITO" ${envio.estado === 'EN_TRANSITO' ? 'selected' : ''}>üöö En Tr√°nsito</option>
        <option value="ENTREGADO" ${envio.estado === 'ENTREGADO' ? 'selected' : ''}>‚úÖ Entregado</option>
        <option value="CANCELADO" ${envio.estado === 'CANCELADO' ? 'selected' : ''}>‚ùå Cancelado</option>
        <option value="DEVUELTO" ${envio.estado === 'DEVUELTO' ? 'selected' : ''}>‚Ü©Ô∏è Devuelto</option>
    </select>
</td>
                    <td>${formatearFecha(envio.fechaCreacion)}</td>
                    <td>${formatearMoneda(envio.costoEnvio)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="verSeguimiento(${envio.idEnvio})" title="Ver seguimiento">
                                <i class="fas fa-map-marked-alt"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editarEnvio(${envio.idEnvio})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEnvio(${envio.idEnvio})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        actualizarEstadisticas();
    } catch (error) {
        console.error('Error completo:', error);
        showNotification('Error al cargar env√≠os: ' + error.message, 'error');
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>${error.message}</p>
                        <p>Verifica que el servidor en http://localhost:8082</p>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading.classList.remove('active');
    }
}
function getBadgeEstadoEnvio(estado) {
    const badges = {
        'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
        'PREPARANDO': '<span class="badge badge-proceso">Preparando</span>',
        'EN TRANSITO': '<span class="badge badge-transito">En transito</span>',
        'ENTREGADO': '<span class="badge badge-success">Entregado</span>',
        'CANCELADO': '<span class="badge badge-danger">Cancelado</span>',
        'DEVUELTO': '<span class="badge badge-danger">Devuelto</span>'
    };
    return badges[estado] || `<span class="badge badge-info">${estado}</span>`;
}

async function mostrarModalEnvio(id = null) {
    document.getElementById('tituloModalEnvio').textContent = id ? 'Editar Env√≠o' : 'Nuevo Env√≠o';
    document.getElementById('formEnvio').reset();
    document.getElementById('envioId').value = id || '';
    
    await cargarClientesSelect();
    await cargarMetodosSelect();
    await cargarRutasSelect();
    await cargarTransportistasSelect();
    
    if (id) {
        try {
            const response = await fetch(`${API_BASE}/envios/${id}`);
            const envio = await response.json();
            
            document.getElementById('envioClienteId').value = envio.cliente?.idCliente || '';
            document.getElementById('envioVentaId').value = envio.venta?.idVenta || '';
            document.getElementById('envioDireccion').value = envio.direccionEntrega || '';
            document.getElementById('envioCiudad').value = envio.ciudad || '';
            document.getElementById('envioEstado').value = envio.estadoDestino || '';
            document.getElementById('envioCP').value = envio.codigoPostal || '';
            document.getElementById('envioTelefono').value = envio.telefonoContacto || '';
            document.getElementById('envioReferencias').value = envio.referenciaDireccion || '';
            document.getElementById('envioMetodoId').value = envio.metodoEnvio?.idMetodoEnvio || '';
            document.getElementById('envioRutaId').value = envio.ruta?.idRuta || '';
            document.getElementById('envioTransportistaId').value = envio.transportista?.idTransportista || '';
            document.getElementById('envioFechaEstimada').value = envio.fechaEstimadaEntrega || '';
            document.getElementById('envioPeso').value = envio.pesoKg || '';
            document.getElementById('envioCosto').value = envio.costoEnvio || '';
            document.getElementById('envioObservaciones').value = envio.observaciones || '';
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error al cargar env√≠o', 'error');
        }
    }
    
    document.getElementById('modalEnvio').classList.add('active');
}

function cerrarModalEnvio() {
    document.getElementById('modalEnvio').classList.remove('active');
}

async function guardarEnvio(event) {
    event.preventDefault();
    
    const id = document.getElementById('envioId').value;
    const ventaId = document.getElementById('envioVentaId').value;
    
    const envio = {
        cliente: { idCliente: parseInt(document.getElementById('envioClienteId').value) },
        venta: ventaId ? { idVenta: parseInt(ventaId) } : null,
        direccionEntrega: document.getElementById('envioDireccion').value,
        ciudad: document.getElementById('envioCiudad').value,
        estadoDestino: document.getElementById('envioEstado').value,
        codigoPostal: document.getElementById('envioCP').value || null,
        telefonoContacto: document.getElementById('envioTelefono').value || null,
        referenciaDireccion: document.getElementById('envioReferencias').value || null,
        metodoEnvio: document.getElementById('envioMetodoId').value ? 
            { idMetodoEnvio: parseInt(document.getElementById('envioMetodoId').value) } : null,
        ruta: document.getElementById('envioRutaId').value ? 
            { idRuta: parseInt(document.getElementById('envioRutaId').value) } : null,
        transportista: document.getElementById('envioTransportistaId').value ? 
            { idTransportista: parseInt(document.getElementById('envioTransportistaId').value) } : null,
        fechaEstimadaEntrega: document.getElementById('envioFechaEstimada').value || null,
        pesoKg: parseFloat(document.getElementById('envioPeso').value) || null,
        costoEnvio: parseFloat(document.getElementById('envioCosto').value) || null,
        observaciones: document.getElementById('envioObservaciones').value || null
    };
    
    try {
        const url = id ? `${API_BASE}/envios/${id}` : `${API_BASE}/envios`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(envio)
        });
        
        if (response.ok) {
            showNotification(`Env√≠o ${id ? 'actualizado' : 'creado'} exitosamente`, 'success');
            cerrarModalEnvio();
            cargarEnvios();
        } else {
            const error = await response.text();
            showNotification(error || 'Error al guardar env√≠o', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al guardar env√≠o', 'error');
    }
}

async function editarEnvio(id) {
    await mostrarModalEnvio(id);
}

async function eliminarEnvio(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este env√≠o? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/envios/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('Env√≠o eliminado exitosamente', 'success');
            cargarEnvios();
            actualizarEstadisticas();
        } else {
            const error = await response.text();
            showNotification(error || 'Error al eliminar env√≠o', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al eliminar env√≠o', 'error');
    }
}
async function cambiarEstadoRapido(idEnvio, nuevoEstado, selectElement) {
    const select = selectElement || (event && event.target) || document.querySelector(`select[data-envio-id="${idEnvio}"]`);
    
    if (!select) {
        console.error('No se pudo encontrar el elemento select');
        showNotification('Error: No se pudo encontrar el elemento', 'error');
        return;
    }
    
    let estadoAnterior = select.dataset.estadoActual;
    if (!estadoAnterior) {
        estadoAnterior = select.options[select.selectedIndex].getAttribute('value') || select.value;
        select.dataset.estadoActual = estadoAnterior;
    }
    
    console.log('Estado anterior:', estadoAnterior, 'Nuevo estado:', nuevoEstado);
    
    if (nuevoEstado === estadoAnterior) {
        console.log('El estado es el mismo, no se hace nada');
        return;
    }
    
    const transicionesInvalidas = validarTransicionEstado(estadoAnterior, nuevoEstado);
    if (transicionesInvalidas) {
        showNotification(transicionesInvalidas, 'warning');
        select.value = estadoAnterior;
        return;
    }
    
    const requiereConfirmacion = ['CANCELADO', 'DEVUELTO'].includes(nuevoEstado);
    let razon = null;
    
    if (requiereConfirmacion) {
        const mensajes = {
            'CANCELADO': '‚ö†Ô∏è ¬øEst√°s seguro de CANCELAR este env√≠o?\n\nEsta acci√≥n no se puede deshacer y el env√≠o quedar√° marcado como cancelado.',
            'DEVUELTO': '‚ö†Ô∏è ¬øEst√°s seguro de marcar este env√≠o como DEVUELTO?\n\nEsto indica que el paquete fue retornado al remitente.'
        };
        
        if (!confirm(mensajes[nuevoEstado])) {
            select.value = estadoAnterior;
            return;
        }
        
        razon = prompt(`Por favor, indica la raz√≥n del ${nuevoEstado.toLowerCase()}:`);
        if (!razon || razon.trim() === '') {
            showNotification('Debes proporcionar una raz√≥n', 'warning');
            select.value = estadoAnterior;
            return;
        }
    }
    
    select.disabled = true;
    select.style.opacity = '0.6';
    
    try {
        const descripcion = razon || `Estado actualizado desde la interfaz a ${getEstadoTexto(nuevoEstado)}`;
        
        console.log('Enviando petici√≥n:', { idEnvio, estado: nuevoEstado, descripcion });
        
        const response = await fetch(`${API_BASE}/envios/${idEnvio}/actualizar-estado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                estado: nuevoEstado,
                descripcion: descripcion
            })
        });
        
        if (response.ok) {
            showNotification(`‚úÖ Estado actualizado a ${getEstadoTexto(nuevoEstado)}`, 'success');
            select.dataset.estadoActual = nuevoEstado;
            
            aplicarEstiloEstado(select, nuevoEstado);
            
            actualizarEstadisticas();
            
            cargarEnvios().catch(err => console.error('Error al recargar env√≠os:', err));
            
            if (['CANCELADO', 'DEVUELTO'].includes(nuevoEstado)) {
                setTimeout(() => {
                    showNotification(`üìã El env√≠o ha sido marcado como ${getEstadoTexto(nuevoEstado).toLowerCase()}`, 'info');
                }, 1500);
            }
        } else {
            const errorText = await response.text();
            console.error('Error del servidor:', errorText, 'Status:', response.status);
            showNotification(`Error del servidor: ${errorText || 'Error desconocido'}`, 'error');
            select.value = estadoAnterior;
            select.dataset.estadoActual = estadoAnterior;
            aplicarEstiloEstado(select, estadoAnterior);
        }
    } catch (error) {
        console.error('Error completo:', error);
        showNotification('Error al actualizar estado: ' + error.message, 'error');
        select.value = estadoAnterior;
        select.dataset.estadoActual = estadoAnterior;
        aplicarEstiloEstado(select, estadoAnterior);
    } finally {
        select.disabled = false;
        select.style.opacity = '1';
    }
}

function validarTransicionEstado(estadoActual, estadoNuevo) {
    const transicionesInvalidas = {
        'ENTREGADO': ['PENDIENTE', 'PREPARANDO', 'EN_TRANSITO'],
        'CANCELADO': ['EN_TRANSITO', 'ENTREGADO', 'DEVUELTO']
    };
    
    if (transicionesInvalidas[estadoActual]?.includes(estadoNuevo)) {
        return `No puedes cambiar de ${getEstadoTexto(estadoActual)} a ${getEstadoTexto(estadoNuevo)}`;
    }
    
    if (estadoActual === 'DEVUELTO' && estadoNuevo !== 'DEVUELTO') {
        return 'Un env√≠o devuelto no puede cambiar a otro estado';
    }
    
    return null;
}

function aplicarEstiloEstado(selectElement, estado) {
    const estilos = {
        'PENDIENTE': { bg: '#fff3cd', border: '#ffc107', color: '#856404' },
        'PREPARANDO': { bg: '#d1ecf1', border: '#17a2b8', color: '#0c5460' },
        'EN_TRANSITO': { bg: '#e2d9f3', border: '#6f42c1', color: '#4e2a84' },
        'ENTREGADO': { bg: '#d4edda', border: '#28a745', color: '#155724' },
        'CANCELADO': { bg: '#f8d7da', border: '#dc3545', color: '#721c24' },
        'DEVUELTO': { bg: '#f8d7da', border: '#dc3545', color: '#721c24' }
    };
    
    const estilo = estilos[estado] || { bg: '#fff', border: '#ccc', color: '#333' };
    
    selectElement.style.backgroundColor = estilo.bg;
    selectElement.style.borderColor = estilo.border;
    selectElement.style.color = estilo.color;
    selectElement.style.fontWeight = '600';
    selectElement.style.transition = 'all 0.3s ease';
}

async function cargarEnvios() {
    const loading = document.getElementById('loadingEnvios');
    const tbody = document.getElementById('enviosBody');
    
    if (!tbody) return;
    
    loading?.classList.add('active');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${API_BASE}/envios`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const envios = await response.json();
        console.log(`üì¶ ${envios.length} env√≠os cargados`);
        
        if (envios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No hay env√≠os registrados</h3>
                            <p>Comienza creando un nuevo env√≠o</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = envios.map(envio => {
                const estado = envio.estado || 'PENDIENTE';
                return `
                <tr>
                    <td><strong>${envio.numeroGuia || 'Sin gu√≠a'}</strong></td>
                    <td>${envio.cliente?.nombreRazonSocial || 'N/A'}</td>
                    <td>${envio.ciudad || 'N/A'}, ${envio.estadoDestino || ''}</td>
                    <td>${envio.metodoEnvio?.nombre || 'N/A'}</td>
                    <td>${envio.transportista?.nombre || 'Sin asignar'}</td>
                    <td>
                        <select class="estado-select" 
                                onchange="cambiarEstadoRapido(${envio.idEnvio}, this.value, this)" 
                                data-estado-actual="${estado}"
                                data-envio-id="${envio.idEnvio}"
                                style="background-color: ${getBackgroundEstado(estado)}; 
                                       border-color: ${getBorderEstado(estado)}; 
                                       color: ${getColorEstado(estado)}; 
                                       font-weight: 600;">
                            <option value="PENDIENTE" ${estado === 'PENDIENTE' ? 'selected' : ''}>‚è≥ Pendiente</option>
                            <option value="PREPARANDO" ${estado === 'PREPARANDO' ? 'selected' : ''}>üì¶ Preparando</option>
                            <option value="EN_TRANSITO" ${estado === 'EN_TRANSITO' ? 'selected' : ''}>üöö En Tr√°nsito</option>
                            <option value="ENTREGADO" ${estado === 'ENTREGADO' ? 'selected' : ''}>‚úÖ Entregado</option>
                            <option value="CANCELADO" ${estado === 'CANCELADO' ? 'selected' : ''}>‚ùå Cancelado</option>
                            <option value="DEVUELTO" ${estado === 'DEVUELTO' ? 'selected' : ''}>‚Ü©Ô∏è Devuelto</option>
                        </select>
                    </td>
                    <td>${formatearFecha(envio.fechaCreacion)}</td>
                    <td>${formatearMoneda(envio.costoEnvio)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="verSeguimiento(${envio.idEnvio})" title="Ver seguimiento">
                                <i class="fas fa-map-marked-alt"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editarEnvio(${envio.idEnvio})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEnvio(${envio.idEnvio})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            
            actualizarEstadisticas();
        }
        
    } catch (error) {
        console.error('‚ùå Error al cargar env√≠os:', error);
        
        if (error.name === 'AbortError') {
            showNotification('‚è±Ô∏è Tiempo de espera agotado', 'error');
        } else {
            showNotification('Error al cargar env√≠os', 'error');
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="cargarEnvios()">
                            <i class="fas fa-sync"></i> Reintentar
                        </button>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading?.classList.remove('active');
    }
}

function getBackgroundEstado(estado) {
    const colores = {
        'PENDIENTE': '#fff3cd',
        'PREPARANDO': '#d1ecf1',
        'EN_TRANSITO': '#e2d9f3',
        'ENTREGADO': '#d4edda',
        'CANCELADO': '#f8d7da',
        'DEVUELTO': '#f8d7da'
    };
    return colores[estado] || '#fff';
}

function getBorderEstado(estado) {
    const colores = {
        'PENDIENTE': '#ffc107',
        'PREPARANDO': '#17a2b8',
        'EN_TRANSITO': '#6f42c1',
        'ENTREGADO': '#28a745',
        'CANCELADO': '#dc3545',
        'DEVUELTO': '#dc3545'
    };
    return colores[estado] || '#ccc';
}

function getColorEstado(estado) {
    const colores = {
        'PENDIENTE': '#856404',
        'PREPARANDO': '#0c5460',
        'EN_TRANSITO': '#4e2a84',
        'ENTREGADO': '#155724',
        'CANCELADO': '#721c24',
        'DEVUELTO': '#721c24'
    };
    return colores[estado] || '#333';
}
async function actualizarEstadoEnvio(id) {
    const estados = ['PENDIENTE', 'PREPARANDO', 'EN TRANSITO', 'ENTREGADO', 'CANCELADO', 'DEVUELTO'];
    const estadoActual = prompt('Selecciona el nuevo estado:\n\n' + estados.join('\n'));
    
    if (!estadoActual || !estados.includes(estadoActual.toUpperCase())) {
        showNotification('Estado no v√°lido', 'warning');
        return;
    }
    
    const descripcion = prompt('Descripci√≥n del cambio de estado:');
    if (!descripcion) return;
    
    try {
        const response = await fetch(`${API_BASE}/envios/${id}/actualizar-estado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                estado: estadoActual.toUpperCase(),
                descripcion: descripcion
            })
        });
        
        if (response.ok) {
            showNotification('Estado actualizado exitosamente', 'success');
            cargarEnvios();
        } else {
            showNotification('Error al actualizar estado', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al actualizar estado', 'error');
    }
}

async function verSeguimiento(envioId) {
    document.getElementById('modalSeguimiento').classList.add('active');
    const contenido = document.getElementById('contenidoSeguimiento');
    contenido.innerHTML = '<div class="loading active"><div class="spinner"></div><p>Cargando seguimiento...</p></div>';
    
    try {
        const [envioResponse, seguimientosResponse] = await Promise.all([
            fetch(`${API_BASE}/envios/${envioId}`),
            fetch(`${API_BASE}/envios/${envioId}/seguimiento`)
        ]);
        
        const envio = await envioResponse.json();
        const seguimientos = await seguimientosResponse.json();
        
        let infoEnvio = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                <h3 style="margin-top: 0; color: #333; font-size: 1.1em;">
                    <i class="fas fa-box"></i> Env√≠o #${envio.numeroGuia || envioId}
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                    <div>
                        <strong><i class="fas fa-user"></i> Cliente:</strong><br>
                        <span style="color: #666;">${envio.cliente?.nombreRazonSocial || 'N/A'}</span>
                    </div>
                    <div>
                        <strong><i class="fas fa-truck"></i> Transportista:</strong><br>
                        <span style="color: #666;">${envio.transportista?.nombre || 'Sin asignar'}</span>
                        ${envio.transportista?.empresa ? `<br><small style="color: #999;">${envio.transportista.empresa}</small>` : ''}
                    </div>
                    <div>
                        <strong><i class="fas fa-map-marker-alt"></i> Destino:</strong><br>
                        <span style="color: #666;">${envio.ciudad || 'N/A'}, ${envio.estadoDestino || ''}</span>
                    </div>
                    <div>
                        <strong><i class="fas fa-shipping-fast"></i> M√©todo:</strong><br>
                        <span style="color: #666;">${envio.metodoEnvio?.nombre || 'N/A'}</span>
                    </div>
                </div>
            </div>
        `;
        
        if (seguimientos.length === 0) {
            contenido.innerHTML = infoEnvio + `
                <div class="empty-state">
                    <i class="fas fa-map-marked-alt"></i>
                    <h3>No hay seguimiento disponible</h3>
                </div>
            `;
        } else {
            contenido.innerHTML = infoEnvio + `
                <h4 style="margin-bottom: 15px; color: #333;">
                    <i class="fas fa-history"></i> Historial de Seguimiento
                </h4>
                <div class="timeline">
                    ${seguimientos.map(seg => `
                        <div class="timeline-item">
                            <div class="timeline-icon" style="border-color: ${getColorEstado(seg.estadoEnvio)}; color: ${getColorEstado(seg.estadoEnvio)};">
                                <i class="fas ${getIconoEstado(seg.estadoEnvio)}"></i>
                            </div>
                            <div class="timeline-content" style="border-left-color: ${getColorEstado(seg.estadoEnvio)};">
                                <div class="timeline-date">${formatearFecha(seg.fechaHora)}</div>
                                <div class="timeline-title">${seg.estadoEnvio}</div>
                                ${seg.ubicacionActual ? `<div class="timeline-description"><i class="fas fa-map-marker-alt"></i> ${seg.ubicacionActual}</div>` : ''}
                                ${seg.latitud && seg.longitud ? `<div class="timeline-description" style="font-size: 0.85em; color: #666;"><i class="fas fa-globe"></i> ${seg.latitud}, ${seg.longitud}</div>` : ''}
                                ${seg.descripcion ? `<div class="timeline-description" style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 4px;"><i class="fas fa-comment-alt"></i> ${seg.descripcion}</div>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        contenido.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error al cargar seguimiento</h3>
                <p>Por favor, intenta nuevamente</p>
            </div>
        `;
    }
}

function cerrarModalSeguimiento() {
    document.getElementById('modalSeguimiento').classList.remove('active');
}

function getColorEstado(estado) {
    const colores = {
        'PENDIENTE': '#ffc107',
        'PREPARANDO': '#fd7e14',
        'EN_TRANSITO': '#6f42c1',
        'ENTREGADO': '#28a745',
        'RETRASADO': '#dc3545',
        'INCIDENTE': '#dc3545'
    };
    return colores[estado] || '#4a90e2';
}

function getIconoEstado(estado) {
    const iconos = {
        'PENDIENTE': 'fa-clock',
        'PREPARANDO': 'fa-box',
        'EN_TRANSITO': 'fa-truck',
        'ENTREGADO': 'fa-check-circle',
        'RETRASADO': 'fa-exclamation-triangle',
        'INCIDENTE': 'fa-exclamation-circle'
    };
    return iconos[estado] || 'fa-info-circle';
}

function buscarEnvios() {
    const searchTerm = document.getElementById('searchEnvios').value.toLowerCase();
    const rows = document.querySelectorAll('#enviosBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function filtrarEnvios() {
    const estadoFiltro = document.getElementById('filterEstadoEnvio').value;
    const rows = document.querySelectorAll('#enviosBody tr');
    
    rows.forEach(row => {
        if (row.querySelector('.empty-state')) {
            row.style.display = '';
            return;
        }
        
        if (!estadoFiltro) {
            row.style.display = '';
        } else {
            const selectEstado = row.querySelector('.estado-select');
            
            if (selectEstado) {
                const estadoActual = selectEstado.value;
                row.style.display = estadoActual === estadoFiltro ? '' : 'none';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

async function cargarMetodos() {
    const loading = document.getElementById('loadingMetodos');
    const tbody = document.getElementById('metodosBody');
    
    if (!tbody) return;
    
    loading?.classList.add('active');
    
    try {
        const response = await fetch(`${API_BASE}/metodos-envio?t=${Date.now()}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const metodos = await response.json();
        
        console.log(`‚úÖ ${metodos.length} m√©todos cargados`);
        
        if (metodos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = metodos.map(metodo => `
                <tr>
                    <td><strong>${metodo.nombre}</strong></td>
                    <td>${metodo.descripcion || 'N/A'}</td>
                    <td>${formatearMoneda(metodo.costoBase)}</td>
                    <td>${formatearMoneda(metodo.costoPorKm)}</td>
                    <td>${metodo.tiempoEstimado || 'N/A'}</td>
                    <td><span class="badge badge-${metodo.estado === 'ACTIVO' ? 'success' : 'warning'}">${metodo.estado || 'ACTIVO'}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editarMetodo(${metodo.idMetodoEnvio})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        const badgeMetodos = document.getElementById('badgeMetodos');
        if (badgeMetodos) badgeMetodos.textContent = metodos.length || 0;
        
    } catch (error) {
        console.error('‚ùå Error al cargar m√©todos:', error);
        showNotification('Error al cargar m√©todos: ' + error.message, 'error');
        tbody.innerHTML = `
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>${error.message}</p>
                        <p>Verifica que el servidor est√© activo</p>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading?.classList.remove('active');
    }
}
async function mostrarModalMetodo(id = null) {
    document.getElementById('tituloModalMetodo').textContent = id ? 'Editar Metodo de Env√≠o' : 'Nuevo Metodo de Env√≠o';
    document.getElementById('formMetodo').reset();
    document.getElementById('metodoId').value = id || '';
    
    if (id) {
        try {
            const response = await fetch(`${API_BASE}/metodos-envio/${id}`);
            const metodo = await response.json();
            
            document.getElementById('metodoNombre').value = metodo.nombre;
            document.getElementById('metodoDescripcion').value = metodo.descripcion || '';
            document.getElementById('metodoCostoBase').value = metodo.costoBase || '';
            document.getElementById('metodoCostoPorKm').value = metodo.costoPorKm || '';
            document.getElementById('metodoTiempo').value = metodo.tiempoEstimado || '';
        } catch (error) {
            console.error('Error:', error);
        }
    }
    
    document.getElementById('modalMetodo').classList.add('active');
}

function cerrarModalMetodo() {
    document.getElementById('modalMetodo').classList.remove('active');
}

async function guardarMetodo(event) {
    event.preventDefault();
    
    const id = document.getElementById('metodoId').value;
    const metodo = {
        nombre: document.getElementById('metodoNombre').value,
        descripcion: document.getElementById('metodoDescripcion').value || null,
        costoBase: parseFloat(document.getElementById('metodoCostoBase').value) || null,
        costoPorKm: parseFloat(document.getElementById('metodoCostoPorKm').value) || null,
        tiempoEstimado: document.getElementById('metodoTiempo').value || null
    };
    
    try {
        const url = id ? `${API_BASE}/metodos-envio/${id}` : `${API_BASE}/metodos-envio`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(metodo)
        });
        
        if (response.ok) {
            showNotification(`M√©todo ${id ? 'actualizado' : 'creado'} exitosamente`, 'success');
            cerrarModalMetodo();
            cargarMetodos();
        } else {
            const error = await response.text();
            showNotification(error || 'Error al guardar m√©todo', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al guardar m√©todo', 'error');
    }
}

async function editarMetodo(id) {
    await mostrarModalMetodo(id);
}

function buscarMetodos() {
    const searchTerm = document.getElementById('searchMetodos').value.toLowerCase();
    const rows = document.querySelectorAll('#metodosBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

async function cargarTransportistas() {
    const loading = document.getElementById('loadingTransportistas');
    const tbody = document.getElementById('transportistasBody');
    
    if (!tbody) return;
    
    loading?.classList.add('active');
    
    try {
        const response = await fetch(`${API_BASE}/transportistas/activos?t=${Date.now()}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const transportistas = await response.json();
        
        if (transportistas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <i class="fas fa-user-tie"></i>
                            <h3>No hay transportistas registrados</h3>
                            <p>Comienza agregando un nuevo transportista</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = transportistas.map(trans => `
                <tr>
                    <td><strong>${trans.nombre}</strong></td>
                    <td>${trans.empresa || 'N/A'}</td>
                    <td>${trans.telefono || 'N/A'}</td>
                    <td>${trans.email || 'N/A'}</td>
                    <td>${trans.tipoVehiculo || 'N/A'}</td>
                    <td>${trans.placaVehiculo || 'N/A'}</td>
                    <td><span class="badge badge-${trans.estado === 'ACTIVO' ? 'success' : 'warning'}">${trans.estado}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editarTransportista(${trans.idTransportista})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        const badgeTransportistas = document.getElementById('badgeTransportistas');
        if (badgeTransportistas) badgeTransportistas.textContent = transportistas.length || 0;
        
        console.log(`‚úÖ ${transportistas.length} transportistas cargados`);
        
    } catch (error) {
        console.error('‚ùå Error al cargar transportistas:', error);
        showNotification('Error al cargar transportistas', 'error');
        tbody.innerHTML = `
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>Por favor, verifica que el servidor estado activo</p>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading?.classList.remove('active');
    }
}

async function mostrarModalTransportista(id = null) {
    document.getElementById('tituloModalTransportista').textContent = id ? 'Editar Transportista' : 'Nuevo Transportista';
    document.getElementById('formTransportista').reset();
    document.getElementById('transportistaId').value = id || '';
    
    if (id) {
        try {
            const response = await fetch(`${API_BASE}/transportistas/${id}`);
            const trans = await response.json();
            
            document.getElementById('transportistaNombre').value = trans.nombre;
            document.getElementById('transportistaEmpresa').value = trans.empresa || '';
            document.getElementById('transportistaTelefono').value = trans.telefono || '';
            document.getElementById('transportistaEmail').value = trans.email || '';
            document.getElementById('transportistaTipoVehiculo').value = trans.tipoVehiculo || '';
            document.getElementById('transportistaPlaca').value = trans.placaVehiculo || '';
            document.getElementById('transportistaLicencia').value = trans.licencia || '';
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error al cargar transportista', 'error');
        }
    }
    
    document.getElementById('modalTransportista').classList.add('active');
}

function cerrarModalTransportista() {
    document.getElementById('modalTransportista').classList.remove('active');
}

async function guardarTransportista(event) {
    event.preventDefault();
    
    const id = document.getElementById('transportistaId').value;
    const transportista = {
        nombre: document.getElementById('transportistaNombre').value,
        empresa: document.getElementById('transportistaEmpresa').value || null,
        telefono: document.getElementById('transportistaTelefono').value || null,
        email: document.getElementById('transportistaEmail').value || null,
        tipoVehiculo: document.getElementById('transportistaTipoVehiculo').value || null,
        placaVehiculo: document.getElementById('transportistaPlaca').value || null,
        licencia: document.getElementById('transportistaLicencia').value || null
    };
    
    try {
        const url = id ? `${API_BASE}/transportistas/${id}` : `${API_BASE}/transportistas`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transportista)
        });
        
        if (response.ok) {
            cerrarModalTransportista();
            
            await cargarTransportistas();
            
            const tabEnvios = document.getElementById('tab-envios');
            if (tabEnvios && tabEnvios.classList.contains('active')) {
                await cargarEnvios();
            }
            
            showNotification(`Transportista ${id ? 'actualizado' : 'creado'} exitosamente`, 'success');
        } else {
            const error = await response.text();
            showNotification(error || 'Error al guardar transportista', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al guardar transportista', 'error');
    }
}

async function editarTransportista(id) {
    await mostrarModalTransportista(id);
}

function buscarTransportistas() {
    const searchTerm = document.getElementById('searchTransportistas').value.toLowerCase();
    const rows = document.querySelectorAll('#transportistasBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

async function cargarRutas() {
    const loading = document.getElementById('loadingRutas');
    const tbody = document.getElementById('rutasBody');
    
    loading.classList.add('active');
    
    try {
        const response = await fetch(`${API_BASE}/rutas/activas`);
        const rutas = await response.json();
        
        if (rutas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i class="fas fa-route"></i>
                            <h3>No hay rutas registradas</h3>
                            <p>Comienza agregando una nueva ruta</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = rutas.map(ruta => `
                <tr>
                    <td><strong>${ruta.codigoRuta || 'N/A'}</strong></td>
                    <td>${ruta.nombreRuta || 'N/A'}</td>
                    <td>${ruta.origen || 'N/A'}</td>
                    <td>${ruta.destino || 'N/A'}</td>
                    <td>${ruta.distanciaKm ? parseFloat(ruta.distanciaKm).toFixed(2) : 'N/A'}</td>
                    <td>${ruta.tiempoEstimadoMin || 'N/A'}</td>
                    <td>${formatearMoneda(ruta.costoEstimado)}</td>
                    <td><span class="badge badge-${ruta.estado === 'ACTIVA' ? 'success' : 'warning'}">${ruta.estado}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editarRuta(${ruta.idRuta})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        const badgeRutas = document.getElementById('badgeRutas');
        if (badgeRutas) badgeRutas.textContent = rutas.length || 0;
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al cargar rutas', 'error');
        tbody.innerHTML = `
            <tr>
                <td colspan="9">
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar datos</h3>
                        <p>Por favor, verifica que el servidor estado activo</p>
                    </div>
                </td>
            </tr>
        `;
    } finally {
        loading.classList.remove('active');
    }
}

async function mostrarModalRuta(id = null) {
    document.getElementById('tituloModalRuta').textContent = id ? 'Editar Ruta' : 'Nueva Ruta';
    document.getElementById('formRuta').reset();
    document.getElementById('rutaId').value = id || '';
    
    if (id) {
        try {
            const response = await fetch(`${API_BASE}/rutas/${id}`);
            const ruta = await response.json();
            
            document.getElementById('rutaCodigo').value = ruta.codigoRuta || '';
            document.getElementById('rutaNombre').value = ruta.nombreRuta || '';
            document.getElementById('rutaOrigen').value = ruta.origen || '';
            document.getElementById('rutaDestino').value = ruta.destino || '';
            document.getElementById('rutaDistancia').value = ruta.distanciaKm || '';
            document.getElementById('rutaTiempo').value = ruta.tiempoEstimadoMin || '';
            document.getElementById('rutaCosto').value = ruta.costoEstimado || '';
            document.getElementById('rutaReferencias').value = ruta.referencias || '';
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error al cargar ruta', 'error');
        }
    }
    
    document.getElementById('modalRuta').classList.add('active');
}

function cerrarModalRuta() {
    document.getElementById('modalRuta').classList.remove('active');
}

async function guardarRuta(event) {
    event.preventDefault();
    
    const id = document.getElementById('rutaId').value;
    const ruta = {
        codigoRuta: document.getElementById('rutaCodigo').value || null,
        nombreRuta: document.getElementById('rutaNombre').value || null,
        origen: document.getElementById('rutaOrigen').value || null,
        destino: document.getElementById('rutaDestino').value || null,
        distanciaKm: parseFloat(document.getElementById('rutaDistancia').value) || null,
        tiempoEstimadoMin: parseInt(document.getElementById('rutaTiempo').value) || null,
        costoEstimado: parseFloat(document.getElementById('rutaCosto').value) || null,
        referencias: document.getElementById('rutaReferencias').value || null
    };
    
    try {
        const url = id ? `${API_BASE}/rutas/${id}` : `${API_BASE}/rutas`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ruta)
        });
        
        if (response.ok) {
            showNotification(`Ruta ${id ? 'actualizada' : 'creada'} exitosamente`, 'success');
            cerrarModalRuta();
            cargarRutas();
        } else {
            const error = await response.text();
            showNotification(error || 'Error al guardar ruta', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al guardar ruta', 'error');
    }
}

async function editarRuta(id) {
    await mostrarModalRuta(id);
}

function buscarRutas() {
    const searchTerm = document.getElementById('searchRutas').value.toLowerCase();
    const rows = document.querySelectorAll('#rutasBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

async function cargarClientesSelect() {
    try {
        console.log('√∞≈∏‚Äù‚Äû Cargando clientes desde:', `${API_BASE}/clientes/activos`);
        
        const response = await fetch(`${API_BASE}/clientes/activos`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const clientes = await response.json();
        
        console.log('√¢≈ì‚Ä¶ Respuesta recibida:', clientes);
        console.log('√∞≈∏‚Äú≈† Total clientes:', clientes.length);
        
        if (clientes.length > 0) {
            console.log('√∞≈∏‚Äù¬ç Estructura primer cliente:', clientes[0]);
            console.log('√∞≈∏‚Äù‚Äò Campos disponibles:', Object.keys(clientes[0]));
        }
        
        const select = document.getElementById('envioClienteId');
        select.innerHTML = '<option value="">Seleccionar cliente</option>';
        
        if (!Array.isArray(clientes) || clientes.length === 0) {
            select.innerHTML += '<option value="" disabled>No hay clientes activos</option>';
            showNotification('No hay clientes activos registrados', 'warning');
            return;
        }
        
        clientes.forEach((cliente, index) => {
            const nombre = cliente.nombreRazonSocial || 'Sin nombre';
            const id = cliente.idCliente;
            const rfc = cliente.rfc || '';
            
            console.log(`Cliente ${index + 1}:`, {
                id: id,
                nombre: nombre,
                rfc: rfc
            });
            
            const textoOpcion = rfc ? `${nombre} (${rfc})` : nombre;
            
            if (id && nombre !== 'Sin nombre') {
                select.innerHTML += `<option value="${id}">${textoOpcion}</option>`;
            }
        });
        
        const totalOpciones = select.children.length - 1;
        console.log(`‚úÖ Select poblado con ${totalOpciones} clientes`);
        
        if (totalOpciones > 0) {
            showNotification(`${totalOpciones} clientes cargados correctamente`, 'success');
        }
        
    } catch (error) {
        console.error('√¢¬ù≈í Error al cargar clientes:', error);
        
        const select = document.getElementById('envioClienteId');
        select.innerHTML = '<option value="">Error al cargar clientes</option>';
        
        showNotification('Error al cargar clientes: ' + error.message, 'error');
    }
}

async function cargarMetodosSelect() {
    try {
        const response = await fetch(`${API_BASE}/metodos-envio/activos`);
        const metodos = await response.json();
        
        const select = document.getElementById('envioMetodoId');
        select.innerHTML = '<option value="">Seleccionar m√©todo</option>';
        metodos.forEach(metodo => {
            select.innerHTML += `<option value="${metodo.idMetodoEnvio}">${metodo.nombre}</option>`;
        });
    } catch (error) {
        console.error('Error al cargar m√©todos:', error);
        showNotification('Error al cargar m√©todos de env√≠o', 'warning');
    }
}

async function cargarRutasSelect() {
    try {
        const response = await fetch(`${API_BASE}/rutas/activas`);
        const rutas = await response.json();
        
        const select = document.getElementById('envioRutaId');
        select.innerHTML = '<option value="">Seleccionar ruta</option>';
        rutas.forEach(ruta => {
            select.innerHTML += `<option value="${ruta.idRuta}">${ruta.nombreRuta || ruta.codigoRuta}</option>`;
        });
    } catch (error) {
        console.error('Error al cargar rutas:', error);
        showNotification('Error al cargar rutas', 'warning');
    }
}

async function cargarTransportistasSelect() {
    try {
        const response = await fetch(`${API_BASE}/transportistas/activos`);
        const transportistas = await response.json();
        
        const select = document.getElementById('envioTransportistaId');
        select.innerHTML = '<option value="">Seleccionar transportista</option>';
        transportistas.forEach(trans => {
            const nombreCompleto = trans.empresa ? `${trans.nombre} - ${trans.empresa}` : trans.nombre;
            select.innerHTML += `<option value="${trans.idTransportista}">${nombreCompleto}</option>`;
        });
    } catch (error) {
        console.error('Error al cargar transportistas:', error);
        showNotification('Error al cargar transportistas', 'warning');
    }
}

function getBadgeClassEstado(estado) {
    const clases = {
        'PENDIENTE': 'warning',
        'PREPARANDO': 'info',
        'EN_TRANSITO': 'primary',
        'ENTREGADO': 'success',
        'CANCELADO': 'danger',
        'DEVUELTO': 'danger'
    };
    return clases[estado] || 'secondary';
}

function getEstadoTexto(estado) {
    const textos = {
        'PENDIENTE': 'Pendiente',
        'PREPARANDO': 'Preparando',
        'EN_TRANSITO': 'En Tr√°nsito',
        'ENTREGADO': 'Entregado',
        'CANCELADO': 'Cancelado',
        'DEVUELTO': 'Devuelto'
    };
    return textos[estado] || estado;
}
    </script>
</body>
                            </html>
